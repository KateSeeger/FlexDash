---
title: "Flexdashboard1.0"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: scroll
    theme:  
          version: 4
          bootswatch: litera
  
runtime: shiny
---
```{r}
#qaqc list - put in document this dashboard does this to clean the dashboard
#do the DBH - BA conversion - would need the event table
#data check page, highlight records with potential problems
#reactables filter each column
#tbl_
#plot_
#df_

```

```{r setup, include=FALSE}

rm(list=ls())
### NOTES
# Converted all tibbles to data frames to get rid of phantom column name errors

### NAMING RULES
# Functions: FuncTest(dat1_there, dat2_here)
# Action buttons: button_PushMe
# User inputs: sel_SelectMe
# Lists, data frames, vectors, variables...: station_files_list, station_df,  station_vec, here_is_a_variable
# Data frame cols: df$ColThisOne, df$ColThatOne
# List elements: list$ElementOne, list$ElementTwo
# Reactive elements: rv$ThisOne, rv$ThatOne
# Temporary variables: temp_this_df
# Well panel id's: wp_FilterParkSite

### Load libraries -----
# Will automatically install any libraries it can't find
pkgs <- c("flexdashboard", 
              "shiny", 
              "knitr", 
              "odbc", # pull data from SQL server
              "scales",
              "leaflet", 
              "here",
              "RgoogleMaps", # for mapzoom
              "plotly", 
              "tidyverse", 
              "plyr", 
              "readr",
              "magrittr",
              "bslib", 
              "ggplot2",
              "gt", 
              "patchwork",
              "webshot2",
              "leaflet.extras", 
              "lubridate", 
              "here", 
              "httr", # use web services
              "rgdal", # to use readOGR
              "sp", # transform projections
              "purrr", # for applying functions to dplyr groups
              "dataMaid", # for data checks
              "shinyFiles", # for user to save files in specified location
              "RColorBrewer", # to display brewer palettes
              "shinyjs", # for easy functions that use JavaScript
              "stringr", # to detect text snippets
              "tmaptools", # for flexible color mapping
              "reactable",
              "base", 
              "htmltools", 
              "ggthemes",
              "psych",
              "sparkline",
              "data.table", # for fast lag calcs
              "DT", # for interactive tables
              "zoo", # for year-month and carry-forward NA's for lag
              "cowplot", # to get legends from plots
              "crosstalk", # for SharedData
              "gridExtra", # for arranging plots and adding plot annotations (ggplotly can't do captions or subtitles)
              "RgoogleMaps", # for MaxZoom & MinZoom
              "leaflet.minicharts") # for pie charts in leaflet maps


installed_pkgs <- pkgs %in% installed.packages()
if (length(pkgs[!installed_pkgs]) > 0) install.packages(pkgs[!installed_pkgs],dep=TRUE) 
lapply(pkgs, library, character.only = TRUE)

invisible(lapply(pkgs, library, character.only = TRUE))

rv <- reactiveValues(
  select_group = NULL, 
  rich_group = NULL, 
  df_rich = NULL
)
```

```{r data}
# reading in data -----
# setwd("C:/Users/kseeger/OneDrive - DOI/Desktop/GIT_RSTUDIO/FLEXDASHBOARD")

# Reading in CSV files
tree_basics <- read_csv(here::here("FLEXDASHBOARD", "TreeBasics_20221013.csv"))
seedling_sapling <- read_csv(here::here("FLEXDASHBOARD", "SeedlingSapling_20221013.csv"))
cwd_basics <- read_csv(here::here("FLEXDASHBOARD","CWD_Basics_20221013.csv"))
canopy_cover <- read_csv(here::here("FLEXDASHBOARD","CanopyCover_20221021.csv"))
USNVC <- read_csv(here::here("FLEXDASHBOARD","USNVC_dev.csv"))
USNVC_parent <- read_csv(here::here("FLEXDASHBOARD","USNVC.csv"))
constancy <- read_csv(here::here("FLEXDASHBOARD","Constancy_Data.csv"))
constancy_full <- read_csv(here::here("FLEXDASHBOARD","Constancy_Data_Full.csv"))
species_rich <- read_csv(here::here("FLEXDASHBOARD","SpeciesDiversity_LongFormat.csv"))

```

```{r functions}
### Functions-----

#rounding function 
#stick to a certain function naming rule
round_df <- function(x, digits) {
    numeric_columns <- sapply(x, mode) == 'numeric'
    x[numeric_columns] <-  round(x[numeric_columns], digits)
    x
}

options(scipen=999)

#keeping only first letter of character
makeInitials <- function(charVec) {
  make.unique(vapply(strsplit(toupper(charVec), " "), 
                     function(x) paste(substr(x, 1, 1), collapse = ""), 
                     vector("character", 1L)))
}


Okabe_Ito <- c("#E69F00", "#56B4E9", "#009E73", '#CC6677',"#F0E442", "#0072B2", "#D55E00", 
               "#CC79A7", "#000000",'#DDDDDD', '#EE6678', '#99DDFF', 
               '#BBCC33', '#332288', '#882255', '#FFAABB')

# color_pallete_function <- colorRampPalette(
#   colors = Okabe_Ito, 
#   space = "Lab")
# 
# num_colors <- nlevels(BISCCHH_SP_Rich$Species)
# okabepalette <- color_pallete_function(num_colors)
# okabepalette <- setNames(okabepalette, levels(BISCCHH_SP_Rich$Species))

makefun <- function(data) {
  data %>% 
  dplyr::group_by(Plot_Code, Year) %>%
  dplyr::summarize(n())
  
}
##### css functions
integer_columns <- function(maxWidth = 60, ...) {
  colDef(maxWidth = maxWidth, align = "center",...)
}
```

```{css styles, eval = FALSE}
.border-left {
  border-left: 12px solid #555;
}

.header { 
  border-bottom-color: #555;
  border-top-color: #555;
  font-size: 13px;
  font-weight: 500;
}

.group {
  font-size: 12px;
}

.reactable {
font-size: 12px; 
}

.cell {
  font-size: 12px;

}
```








```{r }
#Creating year variable 
tree_basics$Year <- year(mdy(tree_basics$Start_Date))

```

```{r QAQC data}
#finding qaqc events to match dates and plot codes against
treeqaqc <- tree_basics %>%
  dplyr::filter(Event_Type_Name == "QA/QC")

listqaqc <- unique(treeqaqc$Plot_Code)

treelist <- tree_basics %>%
  dplyr::filter(Plot_Code %in% listqaqc) 

#finding plot revisit plots == qaqc plots
treelistrv <- treelist %>%
  dplyr::filter(Event_Type_Name == "Plot Revisit") 

treelistqaqc <- treelist %>%
  dplyr::filter(Event_Type_Name == "QA/QC")
  
treelistest <- treelist %>%
  dplyr::filter(Event_Type_Name == "Plot Establishment") 

```

```{r data wrangling 1}
treerv_num <- makefun(treelistrv)
treeqaqc_num <- makefun(treelistqaqc)
treeest_num <- makefun(treelistqaqc)

```

```{r data wrangling 2}
#joining rv and qaqc, keeping plots and years where both have observations
treerv_num <- full_join(treerv_num, treeqaqc_num, by = c("Plot_Code", "Year"))
treerv_num <- treerv_num %>%
  drop_na()
#est and qaqc
treeest_num <- full_join(treeest_num, treeqaqc_num, by = c("Plot_Code", "Year"))
treeest_num <- treeest_num %>%
  drop_na()

treerv_num <- treerv_num %>%
  dplyr::select(Plot_Code, Year)

treeest_num <- treeest_num %>%
  dplyr::select(Plot_Code, Year)

#join original dataset that includes plot codes in qaqc and left join the ones where 
#there are both observations for revisit/est and qaqc
treerv_df <- left_join(treerv_num, treelistrv, by = c("Plot_Code", "Year"))
treeest_df <- left_join(treeest_num, treelistest, by = c("Plot_Code", "Year"))

#join original qaqc dataset that includes plot codes in qaqc and left join the ones where 
#there are both observations for revisit/est and qaqc
qaqc_revisit <- left_join(treerv_num, treelistqaqc, by = c("Plot_Code", "Year"))
qaqc_est <- left_join(treeest_num, treelistqaqc, by = c("Plot_Code", "Year"))
```

```{r Revisit vs QAQC data}
#comparing revisit and qaqc data
tree_revisit <- full_join(treerv_df, qaqc_revisit, by = c("Plot_Code", "Year", "Tree_Number"))


tree_revisit <- tree_revisit %>%
  dplyr::select(Plot_Code, Year, Event_Type_Name.x,Event_Type_Name.y,  Start_Date.x, Start_Date.y, Tree_Number, Plant_Code.x, Plant_Code.y, DBH.x, DBH.y, Status_Code.x, Status_Code.y, Status_Name.x, Status_Name.y, Crown_Name.x, Crown_Name.y, Crown_Code.y, Crown_Code.y, Vigor_Code.x, Vigor_Code.y, Vigor_Name.x, Vigor_Name.y)
```

```{r creating flagged columns}
#Finding mismatched data between revisit data and QAQC data, status name and DBH
tree_revisit <- tree_revisit %>% 
    dplyr::mutate(Status_mismatch = case_when(Status_Name.x == Status_Name.y ~ FALSE, 
                                       Status_Name.x != Status_Name.y ~ TRUE)) %>% 
    dplyr::mutate(Crown_mismatch = case_when(Crown_Name.x == Crown_Name.y ~ FALSE, 
                                       Crown_Name.x != Crown_Name.y ~ TRUE)) %>% 
    dplyr::mutate(DBH_mismatch = case_when(DBH.x == DBH.y ~ FALSE,
                                    DBH.x < DBH.y ~ FALSE,
                                    DBH.x > DBH.y ~ TRUE)) %>%
  dplyr::mutate(Status_Fallacy = case_when(Status_Code.x > Status_Code.y ~ "Flag")) %>%
  dplyr::mutate(Naming_error = case_when(Plant_Code.x != Plant_Code.y ~ "Flag"))
```






















```{r seedsap}
### Seedling_Sapling per plot

#Calculating DBH using arithmetic average
seedling_sapling <- seedling_sapling %>%
  dplyr::mutate(Sapling01_dbh = Sapling_0_1_DBH*0.5, 
         Sapling12h_dbh = Sapling_1_2half_DBH*1.75, 
         Sapling2h5_dbh = Sapling_2half_5_DBH*3.25,
         Sapling510_dbh = Sapling_5_10_DBH*7.5)

#Finding sum of each column per plot
seedling_sapling_df <- seedling_sapling %>%
  dplyr::filter(Event_Type_Name != "QA/QC") %>%
  dplyr::select(Plot_Code,Seedling_15_30_Tall, 
         Seedling_30_50_Tall, 
         Seedling_50_137_Tall,
         Sapling01_dbh,
         Sapling12h_dbh,
         Sapling2h5_dbh,
         Sapling510_dbh, 
         Sapling_0_1_DBH,
         Sapling_1_2half_DBH, 
         Sapling_2half_5_DBH,
         Sapling_5_10_DBH) %>%
  dplyr::group_by (Plot_Code) %>%
  dplyr::summarise(across(everything(), sum, na.rm = TRUE), .groups = 'drop')


#Calculating Sapling BA (m2/ha)
seedling_sapling_df <- seedling_sapling_df %>%
  dplyr::mutate(
    Sapling01_BA = (0.00007854 * (Sapling01_dbh^2)),
    Sapling12h_BA = (0.00007854* (Sapling12h_dbh ^2)),
    Sapling2h5_BA = (0.00007854 * (Sapling2h5_dbh ^2)),
    Sapling510_BA = (0.00007854* (Sapling510_dbh^2)))

#Finding sums of Sapling/Seedlings/BA
seedling_sapling_df <- seedling_sapling_df %>%
  group_by(Plot_Code) %>%
  dplyr::mutate(Seedling_Density = sum(Seedling_15_30_Tall,
                                Seedling_30_50_Tall,
                                Seedling_50_137_Tall), 
         Sapling_BA = sum(Sapling01_BA, 
                              Sapling12h_BA, 
                              Sapling2h5_BA,
                              Sapling510_BA)/0.008, 
         Sapling_Density = sum(Sapling_0_1_DBH,
                               Sapling_1_2half_DBH,
                               Sapling_2half_5_DBH,
                               Sapling_5_10_DBH)) 

woody_stem <- seedling_sapling_df %>%
  dplyr::select(Plot_Code,
         Sapling_BA,
         Sapling_Density,
         Seedling_Density)


#Tree_Basics 
#Basal area in square meters = pi * (dbh^2) / 40000
tree_basics_baden <- tree_basics %>%
  dplyr::filter(Event_Type_Name != "QA/QC") %>%
  dplyr::mutate(Basal_Area_ha = (0.00007854 * (DBH^2)/0.04))

#count number of observations of trees for tree density
tree_obs <- tree_basics_baden %>%
  dplyr::group_by(Plot_Code) %>%
  dplyr::summarize(DBH_Obs = n()) %>%
  ungroup() %>%
  dplyr::group_by(Plot_Code) %>%
  dplyr::mutate(DBH_Obs = DBH_Obs/0.04)

tree_basics_df <- tree_basics_baden %>% 
  dplyr::select(Plot_Code,
                Basal_Area_ha) %>%
  dplyr::group_by (Plot_Code) %>%
  dplyr::summarise(across(everything(), sum, na.rm = TRUE), .groups = 'drop')

tree_basics_df <- Reduce(function (...) { merge(..., all = TRUE) },  # Full join
                           list(tree_basics_df, tree_obs))

#% Canopy Cover
canopy_cover_df <- canopy_cover %>%
  dplyr::filter(Event_Type_Name != "QA/QC") %>%
  dplyr::select(Plot_Code, Module_Code, Canopy_Cover_Percent) %>%
  dplyr::group_by(Plot_Code) %>%
  dplyr::summarize(Canopy_Cover_Percent = mean(Canopy_Cover_Percent))

woodystem_full <- Reduce(function (...) { merge(..., all = TRUE) },  # Full join
                           list(tree_basics_df, woody_stem, canopy_cover_df))

woodystem_round <- round_df(woodystem_full, 0)

#HTML compatible code 
df_woodystem <- woodystem_round %>%
  dplyr::rename(Plot = Plot_Code, 
    `Tree Basal Area <br> (m<sup>2</sup>/ha)` = Basal_Area_ha, 
    `Tree Density <br> (400m<sup>2</sup>) ` = DBH_Obs, 
    `Seedling Density <br> (8m<sup>2</sup>)` = Seedling_Density, 
    `Sapling Basal Area <br> (m<sup>2</sup>/ha)` = Sapling_BA, 
    `Sapling Density <br> (80m<sup>2</sup>)` = Sapling_Density, 
    `Mean Canopy Cover <br> (%)` = Canopy_Cover_Percent)

```

```{r}
#this is NOT A GOOD PLOT BECAUSE WE DON'T JUST WANT TO SEE TOTAL RICHNESS IT NEEDS TO BE AT A SPATIAL SCALE
#FOR example in TIMU it was grouped by broadly defined habitat
```
```{r seedsapb2}
##### Seedling_Sapling, per plant sp.
seedling_sapling_b2 <- seedling_sapling %>%
  dplyr::filter(Event_Type_Name != "QA/QC") %>%
  dplyr::select(Plant_Code,Seedling_15_30_Tall, 
         Seedling_30_50_Tall, 
         Seedling_50_137_Tall,
         Sapling01_dbh, 
         Sapling12h_dbh,
         Sapling2h5_dbh,
         Sapling510_dbh, 
         Sapling_0_1_DBH,
         Sapling_1_2half_DBH, 
         Sapling_2half_5_DBH, 
         Sapling_5_10_DBH) %>%
  dplyr::group_by(Plant_Code) %>%
  dplyr::summarise(across(everything(), sum, na.rm = TRUE), .groups = 'drop')

#Converting BA (m2/ha)
seedling_sapling_b2 <- seedling_sapling_b2 %>%
  dplyr::mutate(
    Sapling01_BA = (0.00007854 * (Sapling01_dbh^2)),
    Sapling12h_BA = (0.00007854* (Sapling12h_dbh ^2)),
    Sapling2h5_BA = (0.00007854 * (Sapling2h5_dbh ^2)),
    Sapling510_BA = (0.00007854* (Sapling510_dbh^2)))

#Converting Density to count/HA
seedling_sapling_b2 <- seedling_sapling_b2 %>%
  dplyr::mutate(
    Seedling_Den_15_30_Tall = Seedling_15_30_Tall/0.0008,
    Seedling_Den_30_50_Tall = Seedling_30_50_Tall/0.0008,
    Seedling_Den_50_137_Tall = Seedling_50_137_Tall/0.0008,
    Sapling_Den_0_1_DBH = Sapling_0_1_DBH/0.008, 
    Sapling_Den_1_2half_DBH = Sapling_1_2half_DBH/0.008,
    Sapling_Den_2half_5_DBH = Sapling_2half_5_DBH/0.008,
    Sapling_Den_5_10_DBH = Sapling_5_10_DBH/0.008
  )
  
seedling_sapling_b2 <- seedling_sapling_b2 %>%
  dplyr::group_by(Plant_Code) %>%
  dplyr::mutate(Seedling_Density = sum(Seedling_Den_15_30_Tall,
                                Seedling_Den_30_50_Tall,
                                Seedling_Den_50_137_Tall), 
         Sapling_BA = sum(Sapling01_BA, 
                              Sapling12h_BA,
                              Sapling2h5_BA, 
                              Sapling510_BA)/0.008, 
         Sapling_Density = sum(Sapling_0_1_DBH, 
                               Sapling_1_2half_DBH,
                               Sapling_2half_5_DBH, 
                               Sapling_5_10_DBH)) 

woody_stem_b2 <- seedling_sapling_b2 %>%
  dplyr::select(Plant_Code, 
         Sapling_BA, 
         Sapling_Density, 
         Seedling_Density)

#tree_basics_baden (Tree Basics BA and Density)
#count number of observations of trees for tree density
tree_obs_b2 <- tree_basics_baden %>%
  dplyr::group_by(Plant_Code) %>%
  dplyr::summarize(DBH_Obs = n())

tree_basics_b2 <- tree_basics_baden %>% 
  dplyr::select(Plant_Code,
         Basal_Area_ha) %>%
  dplyr::group_by(Plant_Code) %>%
  dplyr::summarise(across(everything(), sum, na.rm = TRUE), .groups = 'drop')

tree_basics_b2 <- Reduce(function (...) { merge(..., all = TRUE) },  # Full join
                           list(tree_basics_b2, tree_obs_b2))
tree_basics_b2 <- tree_basics_b2 %>%
  dplyr::mutate(DBH_Obs = DBH_Obs*25)
  

woodystem_full_b2 <- Reduce(function (...) { merge(..., all = TRUE) },  # Full join
                           list(tree_basics_b2, woody_stem_b2))

woodystem_round_b2 <- round_df(woodystem_full_b2, 2)

woodystem_round_b2_blank <- woodystem_round_b2
woodystem_round_b2_blank[is.na(woodystem_round_b2)] <- "-"

#GENERAL CODE TO CREATE HTML COMPATIBLE NAMING

woody_b2_general <- woodystem_round_b2_blank %>%
  dplyr::rename(Species = Plant_Code,
    `Tree Basal Area <br> (m<sup>2</sup>/ha)` = Basal_Area_ha, 
    `Tree Density <br> (400m<sup>2</sup>) ` = DBH_Obs, 
    `Seedling Density <br> (8m<sup>2</sup>)` = Seedling_Density, 
    `Sapling Basal Area <br> (m<sup>2</sup>/ha)` = Sapling_BA, 
    `Sapling Density <br> (80m<sup>2</sup>)` = Sapling_Density)
```


```{r plot richness}
species_rich <- species_rich %>%
  tidyr::replace_na(list(Nativity = "Unknown"))

#Summarizing nativity of species per plot
#Using Species_Diversity_ID not Plant Code because doesn't account for sp level differences at plot level 
#Species_Diversity_ID is used differently for each plot, so not a useful metric for species diversity across lager scales (i.e. parks, subunits, etc,)
 
plot_nativity <- species_rich %>%
  dplyr::filter(Sample_Depth_Code != 0) %>%
  dplyr::mutate(Sample_Depth_Code = as.factor(Sample_Depth_Code)
         ) %>%
  dplyr::group_by(Park_Code, Subunit_Code, Plot_Code, Start_Date, Species_Diversity_ID,
           Nativity) %>%
  dplyr::count(Nativity)

plot_nativity <- plot_nativity %>%
  dplyr::group_by(Park_Code, Subunit_Code, Plot_Code, Start_Date) %>%
  dplyr::count(Nativity)

plot_nativity <- plot_nativity %>%
  tidyr::pivot_wider(
    names_from = Nativity, 
    values_from = n
  )

plot_nativity <- plot_nativity %>%
  dplyr::rename_at(vars(-Park_Code, -Subunit_Code, -Plot_Code, -Start_Date),function(x) paste0(x,"<sup>a</sup>"))
```


```{r plot richness 1}
###400 m2 
plot_total <- species_rich %>%
  dplyr::filter(Sample_Depth_Code != 0) %>%
  dplyr::mutate(Sample_Depth_Code = as.factor(Sample_Depth_Code), 
                Growth_Form = toupper(Growth_Form)) %>%
  dplyr::group_by(Park_Code, Subunit_Code, Plot_Code, Start_Date, Species_Diversity_ID, Growth_Form)%>%
  dplyr::count(Growth_Form)

plot_total <- plot_total %>%
  dplyr::group_by(Park_Code, Subunit_Code, Plot_Code, Start_Date, Growth_Form) %>%
  dplyr::summarize(Count = n())

###100m2
plot_mod100 <- species_rich %>%
  dplyr::filter(Sample_Depth_Code != 0) %>%
  dplyr::mutate(Sample_Depth_Code = as.factor(Sample_Depth_Code), 
         Growth_Form = toupper(Growth_Form)) %>%
  dplyr::group_by(Park_Code,
                  Subunit_Code, 
                  Plot_Code, 
                  Start_Date,
           Growth_Form,
           Module, 
           Species_Diversity_ID) %>%
  dplyr::count(Species_Diversity_ID)%>%
  ungroup() %>%
  dplyr::group_by(Park_Code,
                  Subunit_Code, 
                  Plot_Code, 
                  Start_Date,
                  Growth_Form,
                  Module, 
                  Species_Diversity_ID) %>%
  dplyr::count(Module) %>%
  ungroup()%>%
  dplyr::group_by(Park_Code,
                  Subunit_Code, 
                  Plot_Code,
                  Start_Date,
                  Growth_Form,
                  Module) %>%
  dplyr::summarize(numSpecies = sum(n))%>%
  ungroup() %>%
  dplyr::group_by(Park_Code, 
                  Subunit_Code, 
                  Plot_Code,
                  Start_Date,
                  Growth_Form) %>%
  dplyr::summarize(Mod100 = mean(numSpecies)) %>%
  ungroup() %>%
  group_by(Park_Code,
           Subunit_Code, 
           Plot_Code,
           Start_Date,
           Growth_Form) %>%
  dplyr::summarize(Mod100 = sum(Mod100))%>%
  dplyr::ungroup()

### 10m2
plot_mod10 <- species_rich %>%
  dplyr::filter(Sample_Depth_Code != 0, 
         Sample_Depth_Code != 1) %>%
  dplyr::mutate(Sample_Depth_Code = as.factor(Sample_Depth_Code), 
         Growth_Form = toupper(Growth_Form)) %>%
  dplyr::group_by(Park_Code,
                  Subunit_Code, 
                  Plot_Code, 
                  Start_Date,
           Growth_Form,
           Module,
           Corner,
           Species_Diversity_ID) %>%
  dplyr::count(Species_Diversity_ID)%>%
  ungroup() %>%
  dplyr::group_by(Park_Code,
                  Subunit_Code, 
                  Plot_Code, 
                  Start_Date,
           Growth_Form,
           Module,
           Corner,
           Species_Diversity_ID) %>%
  dplyr::count(Corner) %>%
  ungroup()%>%
  dplyr::group_by(Park_Code,
                  Subunit_Code, 
                  Plot_Code,
                  Start_Date,
           Growth_Form,
           Module,
           Corner) %>%
  dplyr::summarize(numSpecies = sum(n)) %>%
  ungroup() %>%
  dplyr::group_by(Park_Code,
                  Subunit_Code, 
                  Plot_Code,
                  Start_Date,
                  Growth_Form) %>%
  dplyr::summarize(Mod10 = mean(numSpecies)) %>%
  ungroup() %>%
  dplyr::group_by(Park_Code, Subunit_Code, Plot_Code, Start_Date,
           Growth_Form) %>%
  dplyr::summarize(Mod10 = sum(Mod10))

###1m2
plot_mod1 <- species_rich %>%
  dplyr::filter(Sample_Depth_Code == 3) %>%
  dplyr::mutate(Sample_Depth_Code = as.factor(Sample_Depth_Code), 
         Growth_Form = toupper(Growth_Form)) %>%
  dplyr::group_by(Park_Code,
                  Subunit_Code, 
                  Plot_Code, 
                  Start_Date,
           Growth_Form, 
           Module,
           Corner,
           Species_Diversity_ID) %>%
  dplyr::count(Species_Diversity_ID)%>%
  ungroup()%>%
  dplyr::group_by(Park_Code,
                  Subunit_Code, 
                  Plot_Code, 
                  Start_Date,
           Growth_Form, 
           Module, 
           Corner,
           Species_Diversity_ID) %>%
  dplyr::count(Corner)%>%
  ungroup()%>%
  dplyr::group_by(Park_Code,
                  Subunit_Code, 
                  Plot_Code,
                  Start_Date,
           Growth_Form,
           Module, 
           Corner) %>%
  dplyr::summarize(numSpecies = sum(n))%>%
  ungroup()%>%
  dplyr::group_by(Park_Code,
                  Subunit_Code, 
                  Plot_Code,
                  Start_Date,
                  Growth_Form) %>%
  dplyr::summarize(Mod1 = mean(numSpecies))%>%
  ungroup()%>%
  dplyr::group_by(Park_Code, Subunit_Code, Plot_Code,Start_Date,
           Growth_Form) %>%
  dplyr::summarize(Mod1 = sum(Mod1))

### full join
plot_rich <- Reduce(function (...) { merge(..., all = TRUE) },  
                           list(plot_total, plot_mod100, plot_mod10, plot_mod1))
```

```{r plot richness 2}
plot_rich <- plot_rich %>%
    mutate(Growth_Form = mapply(function(charVec) makeInitials(charVec), Growth_Form)) #BHT = `GROUP`

plot_rich <- plot_rich %>%
  tidyr::pivot_wider(
    names_from = Growth_Form, 
    values_from = c(Count,
                    Mod100,
                    Mod10, 
                    Mod1), 
    names_prefix = "")

plot_rich <- Reduce(function (...) { merge(..., all = TRUE) },  # Full join
                           list(plot_nativity, plot_rich))

plot_rich <- round_df(plot_rich, 1)

plot_rich <- plot_rich %>%
    replace(is.na(.), 0)

plot_rich <- plot_rich %>%
  dplyr::rename_at(vars(starts_with("Count_")), 
            list(~paste(.,"<sup>a</sup>"))) %>%
  dplyr::rename_at(vars(starts_with("Mod100_")), 
            list(~paste(.,"<sup>b</sup>"))) %>%
  dplyr::rename_at(vars(starts_with("Mod10_")), 
            list(~paste(., "<sup>c</sup>"))) %>%
  dplyr::rename_at(vars(starts_with("Mod1_")), 
            list(~paste(., "<sup>d</sup>")))

names(plot_rich) = gsub(pattern = "Count_", replacement = "", x = names(plot_rich))
names(plot_rich) = gsub(pattern = "Mod100_", replacement = "", x = names(plot_rich))
names(plot_rich) = gsub(pattern = "Mod10_", replacement = "", x = names(plot_rich))
names(plot_rich) = gsub(pattern = "Mod1_", replacement = "", x = names(plot_rich))

df_plotrich <- plot_rich
```

```{r PARK}
renderUI({
  shiny::req(!is.null(input$rich_group), !is.null(species_rich))
  
#use all_of in select(input$code) 

park_nativity <- species_rich %>%
  dplyr::filter(Sample_Depth_Code != 0) %>%
  dplyr::mutate(Sample_Depth_Code = as.factor(Sample_Depth_Code)
         ) %>%
  dplyr::select(all_of(input$rich_group), Network_Scientific_Name,
           Nativity) %>%
  dplyr::distinct()

park_nativity <- park_nativity %>%
  dplyr::group_by(!!as.name(input$rich_group))%>%
  dplyr::count(Nativity)

park_nativity <- park_nativity %>%
  tidyr::pivot_wider(
    names_from = Nativity, 
    values_from = n
  )

park_nativity <- park_nativity %>%
  dplyr::rename_at(vars(-input$rich_group),function(x) paste0(x,"<sup>a</sup>"))

###400 m2 
park_total <- species_rich %>%
  dplyr::filter(Sample_Depth_Code != 0) %>%
  dplyr::mutate(Sample_Depth_Code = as.factor(Sample_Depth_Code), 
                Growth_Form = toupper(Growth_Form)) %>%
  dplyr::group_by(!!as.name(input$rich_group), Network_Scientific_Name, Growth_Form)%>%
  dplyr::count(Growth_Form)

park_total <- park_total %>%
  dplyr::group_by(!!as.name(input$rich_group), Growth_Form) %>%
  dplyr::summarize(Count = n())

###100m2
park_mod100 <- species_rich %>%
  dplyr::filter(Sample_Depth_Code != 0) %>%
  dplyr::mutate(Sample_Depth_Code = as.factor(Sample_Depth_Code), 
         Growth_Form = toupper(Growth_Form)) %>%
  dplyr::group_by(!!as.name(input$rich_group),
           Growth_Form,
           Module, 
           Network_Scientific_Name) %>%
  dplyr::count(Network_Scientific_Name)%>%
  ungroup() %>%
  dplyr::group_by(!!as.name(input$rich_group), 
                  Growth_Form,
                  Module, 
                  Network_Scientific_Name) %>%
  dplyr::count(Module) %>%
  ungroup()%>%
  dplyr::group_by(!!as.name(input$rich_group), 
                  Growth_Form,
                  Module) %>%
  dplyr::summarize(numSpecies = sum(n))%>%
  ungroup() %>%
  dplyr::group_by(!!as.name(input$rich_group),
                  Growth_Form) %>%
  dplyr::summarize(Mod100 = mean(numSpecies)) %>%
  ungroup() %>%
  group_by(!!as.name(input$rich_group),
           Growth_Form) %>%
  dplyr::summarize(Mod100 = sum(Mod100))%>%
  dplyr::ungroup()

### 10m2
park_mod10 <- species_rich %>%
  dplyr::filter(Sample_Depth_Code != 0, 
         Sample_Depth_Code != 1) %>%
  dplyr::mutate(Sample_Depth_Code = as.factor(Sample_Depth_Code), 
         Growth_Form = toupper(Growth_Form)) %>%
  dplyr::group_by(!!as.name(input$rich_group), 
           Growth_Form,
           Module,
           Corner,
           Network_Scientific_Name) %>%
  dplyr::count(Network_Scientific_Name)%>%
  ungroup() %>%
  dplyr::group_by(!!as.name(input$rich_group), 
           Growth_Form,
           Module,
           Corner,
           Network_Scientific_Name) %>%
  dplyr::count(Corner) %>%
  ungroup()%>%
  dplyr::group_by(!!as.name(input$rich_group), 
           Growth_Form,
           Module,
           Corner) %>%
  dplyr::summarize(numSpecies = sum(n)) %>%
  ungroup() %>%
  dplyr::group_by(!!as.name(input$rich_group),
                  Growth_Form) %>%
  dplyr::summarize(Mod10 = mean(numSpecies)) %>%
  ungroup() %>%
  dplyr::group_by(!!as.name(input$rich_group), 
           Growth_Form) %>%
  dplyr::summarize(Mod10 = sum(Mod10))

###1m2
park_mod1 <- species_rich %>%
  dplyr::filter(Sample_Depth_Code == 3) %>%
  dplyr::mutate(Sample_Depth_Code = as.factor(Sample_Depth_Code), 
         Growth_Form = toupper(Growth_Form)) %>%
  dplyr::group_by(!!as.name(input$rich_group), 
           Growth_Form, 
           Module,
           Corner,
           Network_Scientific_Name) %>%
  dplyr::count(Network_Scientific_Name)%>%
  ungroup()%>%
  dplyr::group_by(!!as.name(input$rich_group), 
           Growth_Form, 
           Module, 
           Corner,
           Network_Scientific_Name) %>%
  dplyr::count(Corner)%>%
  ungroup()%>%
  dplyr::group_by(!!as.name(input$rich_group),
           Growth_Form,
           Module, 
           Corner) %>%
  dplyr::summarize(numSpecies = sum(n))%>%
  ungroup()%>%
  dplyr::group_by(!!as.name(input$rich_group),
                  Growth_Form) %>%
  dplyr::summarize(Mod1 = mean(numSpecies))%>%
  ungroup()%>%
  dplyr::group_by(!!as.name(input$rich_group),
           Growth_Form) %>%
  dplyr::summarize(Mod1 = sum(Mod1))

### full join
park_rich <- Reduce(function (...) { merge(..., all = TRUE) },  
                           list(park_total, park_mod100, park_mod10, park_mod1))

park_rich <- park_rich %>%
    mutate(Growth_Form = mapply(function(charVec) makeInitials(charVec), Growth_Form)) #BHT = `GROUP`

park_rich <- park_rich %>%
  tidyr::pivot_wider(
    names_from = Growth_Form, 
    values_from = c(Count,
                    Mod100,
                    Mod10, 
                    Mod1), 
    names_prefix = "")

park_rich <- Reduce(function (...) { merge(..., all = TRUE) },  # Full join
                           list(park_nativity, park_rich))

park_rich <- round_df(park_rich, 1)

park_rich <- park_rich %>%
    replace(is.na(.), 0)

park_rich <- park_rich %>%
  dplyr::rename_at(vars(starts_with("Count_")), 
            list(~paste(.,"<sup>a</sup>"))) %>%
  dplyr::rename_at(vars(starts_with("Mod100_")), 
            list(~paste(.,"<sup>b</sup>"))) %>%
  dplyr::rename_at(vars(starts_with("Mod10_")), 
            list(~paste(., "<sup>c</sup>"))) %>%
  dplyr::rename_at(vars(starts_with("Mod1_")), 
            list(~paste(., "<sup>d</sup>")))

names(park_rich) = gsub(pattern = "Count_", replacement = "", x = names(park_rich))
names(park_rich) = gsub(pattern = "Mod100_", replacement = "", x = names(park_rich))
names(park_rich) = gsub(pattern = "Mod10_", replacement = "", x = names(park_rich))
names(park_rich) = gsub(pattern = "Mod1_", replacement = "", x = names(park_rich))


rv$df_rich <- park_rich

saveRDS(isolate(reactiveValuesToList(input)), paste0("rich_input.RDS"))
saveRDS(isolate(reactiveValuesToList(rv)), paste0("rich_rv.RDS"))

})
```


```{r}
# input <- list() 
# input$rich_group <- "Subunit_Code"
```

```{r Subunit}
subunit_nativity <- species_rich %>%
  dplyr::filter(Sample_Depth_Code != 0) %>%
  dplyr::mutate(Sample_Depth_Code = as.factor(Sample_Depth_Code)
         ) %>%
  dplyr::group_by(Subunit_Code, Plant_Code,
           Nativity) %>%
  dplyr::count(Nativity)

subunit_nativity <- subunit_nativity %>%
  dplyr::group_by(Subunit_Code) %>%
  dplyr::count(Nativity)

subunit_nativity <- subunit_nativity %>%
  tidyr::pivot_wider(
    names_from = Nativity, 
    values_from = n
  )

subunit_nativity <- subunit_nativity %>%
  dplyr::rename_at(vars(-Subunit_Code),function(x) paste0(x,"<sup>a</sup>"))

###400 m2 
subunit_total <- species_rich %>%
  dplyr::filter(Sample_Depth_Code != 0) %>%
  dplyr::mutate(Sample_Depth_Code = as.factor(Sample_Depth_Code), 
                Growth_Form = toupper(Growth_Form)) %>%
  dplyr::group_by(Subunit_Code, Plot_Code, Species_Diversity_ID, Growth_Form)%>%
  dplyr::count(Growth_Form)

subunit_total <- subunit_total %>%
  dplyr::group_by(Subunit_Code, Growth_Form) %>%
  dplyr::summarize(Count = n())

###100m2
subunit_mod100 <- species_rich %>%
  dplyr::filter(Sample_Depth_Code != 0) %>%
  dplyr::mutate(Sample_Depth_Code = as.factor(Sample_Depth_Code), 
         Growth_Form = toupper(Growth_Form)) %>%
  dplyr::group_by(Subunit_Code,
                  Plot_Code, 
           Growth_Form,
           Module, 
           Species_Diversity_ID) %>%
  dplyr::count(Species_Diversity_ID)%>%
  ungroup() %>%
  dplyr::group_by(Subunit_Code,
                  Plot_Code, 
                  Growth_Form,
                  Module, 
                  Species_Diversity_ID) %>%
  dplyr::count(Module) %>%
  ungroup()%>%
  dplyr::group_by(Subunit_Code,
                  Plot_Code, 
                  Growth_Form,
                  Module) %>%
  dplyr::summarize(numSpecies = sum(n))%>%
  ungroup() %>%
  dplyr::group_by(Subunit_Code, 
                  Plot_Code,
                  Growth_Form) %>%
  dplyr::summarize(Mod100 = mean(numSpecies)) %>%
  ungroup() %>%
  group_by(Subunit_Code,
           Growth_Form) %>%
  dplyr::summarize(Mod100 = sum(Mod100))%>%
  dplyr::ungroup()

### 10m2
subunit_mod10 <- species_rich %>%
  dplyr::filter(Sample_Depth_Code != 0, 
         Sample_Depth_Code != 1) %>%
  dplyr::mutate(Sample_Depth_Code = as.factor(Sample_Depth_Code), 
         Growth_Form = toupper(Growth_Form)) %>%
  dplyr::group_by(Subunit_Code,
                  Plot_Code, 
           Growth_Form,
           Module,
           Corner,
           Species_Diversity_ID) %>%
  dplyr::count(Species_Diversity_ID)%>%
  ungroup() %>%
  dplyr::group_by(Subunit_Code,
                  Plot_Code, 
           Growth_Form,
           Module,
           Corner,
           Species_Diversity_ID) %>%
  dplyr::count(Corner) %>%
  ungroup()%>%
  dplyr::group_by(Subunit_Code,
                  Plot_Code, 
           Growth_Form,
           Module,
           Corner) %>%
  dplyr::summarize(numSpecies = sum(n)) %>%
  ungroup() %>%
  dplyr::group_by(Subunit_Code,
                  Plot_Code,
                  Growth_Form) %>%
  dplyr::summarize(Mod10 = mean(numSpecies)) %>%
  ungroup() %>%
  dplyr::group_by(Subunit_Code, 
           Growth_Form) %>%
  dplyr::summarize(Mod10 = sum(Mod10))

###1m2
subunit_mod1 <- species_rich %>%
  dplyr::filter(Sample_Depth_Code == 3) %>%
  dplyr::mutate(Sample_Depth_Code = as.factor(Sample_Depth_Code), 
         Growth_Form = toupper(Growth_Form)) %>%
  dplyr::group_by(Subunit_Code,
                  Plot_Code, 
           Growth_Form, 
           Module,
           Corner,
           Species_Diversity_ID) %>%
  dplyr::count(Species_Diversity_ID)%>%
  ungroup()%>%
  dplyr::group_by(Subunit_Code,
                  Plot_Code, 
           Growth_Form, 
           Module, 
           Corner,
           Species_Diversity_ID) %>%
  dplyr::count(Corner)%>%
  ungroup()%>%
  dplyr::group_by(Subunit_Code,
                  Plot_Code,
           Growth_Form,
           Module, 
           Corner) %>%
  dplyr::summarize(numSpecies = sum(n))%>%
  ungroup()%>%
  dplyr::group_by(Subunit_Code,
                  Plot_Code,
                  Growth_Form) %>%
  dplyr::summarize(Mod1 = mean(numSpecies))%>%
  ungroup()%>%
  dplyr::group_by(Subunit_Code,
           Growth_Form) %>%
  dplyr::summarize(Mod1 = sum(Mod1))
```

```{r subunit 2}
### full join
subunit_rich <- Reduce(function (...) { merge(..., all = TRUE) },  
                           list(subunit_total, subunit_mod100, subunit_mod10, subunit_mod1))
```

```{r subunit 3}

subunit_rich <- subunit_rich %>%
    mutate(Growth_Form = mapply(function(charVec) makeInitials(charVec), Growth_Form)) #BHT = `GROUP`

subunit_rich <- subunit_rich %>%
  tidyr::pivot_wider(
    names_from = Growth_Form, 
    values_from = c(Count,
                    Mod100,
                    Mod10, 
                    Mod1), 
    names_prefix = "")

subunit_rich <- Reduce(function (...) { merge(..., all = TRUE) },  # Full join
                           list(subunit_nativity, subunit_rich))

subunit_rich <- round_df(subunit_rich, 1)

subunit_rich <- subunit_rich %>%
    replace(is.na(.), 0)

subunit_rich <- subunit_rich %>%
  dplyr::rename_at(vars(starts_with("Count_")), 
            list(~paste(.,"<sup>a</sup>"))) %>%
  dplyr::rename_at(vars(starts_with("Mod100_")), 
            list(~paste(.,"<sup>b</sup>"))) %>%
  dplyr::rename_at(vars(starts_with("Mod10_")), 
            list(~paste(., "<sup>c</sup>"))) %>%
  dplyr::rename_at(vars(starts_with("Mod1_")), 
            list(~paste(., "<sup>d</sup>")))

names(subunit_rich) = gsub(pattern = "Count_", replacement = "", x = names(subunit_rich))
names(subunit_rich) = gsub(pattern = "Mod100_", replacement = "", x = names(subunit_rich))
names(subunit_rich) = gsub(pattern = "Mod10_", replacement = "", x = names(subunit_rich))
names(subunit_rich) = gsub(pattern = "Mod1_", replacement = "", x = names(subunit_rich))

df_subunitrich <- subunit_rich
```


```{r}
#Constancy_Table
#Finding average mean plot cover by species across broad habitat types
cover_calc <- constancy_full %>%
  dplyr::select(`BROAD HABITAT TYPE`,
                Species_Original,
                `Mean Plot Cover`) %>%
  dplyr::group_by(`BROAD HABITAT TYPE`,
           Species_Original) %>%
  dplyr::summarise(Avg_MPC = mean(`Mean Plot Cover`))%>%
  ungroup()

cover_calc <- cover_calc %>%
  mutate(Group = mapply(function(charVec) makeInitials(charVec), `BROAD HABITAT TYPE`)) #BHT = `GROUP`
  
cover_calc <- cover_calc %>%
  select(Species_Original, Group, Avg_MPC) %>%
    pivot_wider(names_from = `Group`, 
    values_from = Avg_MPC
  )

cover_code <- cover_calc %>%
  mutate_if(is.numeric, list(~case_when(
    . >= 0 & . <=0.1~ "1",
                     . >= 0.1 & . <=1~ "2",
                     . >= 1 & . <= 2 ~ "3",
                     . >= 2 & . <= 5 ~ "4",
                     . >= 5 & . <= 10 ~ "5",
                     . >= 10 & . <=25~ "6",
                     . >= 25 & . <=50~ "7",
                     . >= 50 & . <= 75 ~ "8",
                     . >= 75 & . <=95 ~ "9",
                     . >= 95 & . <= 100 ~ "10" )
  ))

cover_code <- cover_code %>%
  rename_at(vars(-Species_Original),function(x) paste0(x,"_Cover")) %>% #general code would be -Plant_Code
  mutate_at(vars(-Species_Original), as.integer)
```

```{r}
# Constancy Count
constancy_count <- constancy_full %>%
  dplyr::select(`BROAD HABITAT TYPE`, Species_Original, `Mean Plot Cover`) %>%
  dplyr::group_by(`BROAD HABITAT TYPE`, Species_Original) %>%
  dplyr::summarise(Species_Total = n()) 

constancy_count <- constancy_count %>%
  tidyr::pivot_wider(
    names_from = `BROAD HABITAT TYPE`, 
    values_from = Species_Total
  )

#calculating constancy count
constancy_plot_num <- constancy_full%>%
  dplyr::group_by(`BROAD HABITAT TYPE`, event_name_date_calc) %>% #UNSURE IS EVENT_NAME_DATE_CALC IS A UNIVERSAL VARIABLE
  dplyr::summarize(n()) %>%
  ungroup() %>%
  dplyr::group_by(`BROAD HABITAT TYPE`) %>%
  dplyr::summarize(Num_Plots = n())

constancy_count <- constancy_full %>%
  dplyr::select(`BROAD HABITAT TYPE`, Species_Original, `Mean Plot Cover`) %>%
  dplyr::group_by(`BROAD HABITAT TYPE`, Species_Original) %>%
  dplyr::summarise(Species_Total = n()) 

constancy_count <- left_join(constancy_count, constancy_plot_num, by = "BROAD HABITAT TYPE")

constancy_count <- constancy_count %>% 
  dplyr::group_by(`BROAD HABITAT TYPE`) %>%
  dplyr::mutate(Constancy = (Species_Total/Num_Plots)*100) %>%
  dplyr::select(`BROAD HABITAT TYPE`, Species_Original, Constancy) %>%
  ungroup()

constancy_count <- constancy_count %>%
   dplyr::mutate(Group = mapply(function(charVec) makeInitials(charVec), `BROAD HABITAT TYPE`)) #BHT = `GROUP`

constancy_count <- constancy_count %>%
  dplyr::select(-`BROAD HABITAT TYPE`) %>%
  tidyr::pivot_wider(names_from = Group, 
              values_from = Constancy)

constancy_count <- constancy_count %>%
    rename_at(vars(-Species_Original),function(x) paste0(x,"_Constancy"))

constancy_count <- round_df(constancy_count, 0)

```

```{r}
#CODE FOR Constancy/Count CREATING FINAL DATASET

constancy_final <- Reduce(function (...) { merge(..., all = TRUE) },  #full join idk why I can't just do a regular left join....
                        list(cover_code, constancy_count))

constancy_final[constancy_final == 0] <- NA

constancy_final[is.na(constancy_final)] <- "-"

constancy_final<- constancy_final  %>%
  tidyr::pivot_longer(cols = - Species_Original,
               names_to = "codes", 
               values_to = "value") %>%
  dplyr::arrange(codes) %>%
  tidyr::pivot_wider(names_from = "codes", 
              values_from = "value")

df_constancyfinal <- constancy_final
```

```{r}
###### Leaflet MAPS
```


















Data Check {data-width=650}
=======================================================================

<br>
<span style="font-size:14px; color:red; font-weight:bold;">
Data issues identified on this page should be fixed in the original data files. The data check should then be RERUN with the UPDATED data files, until data issues are resolved to the extent possible--prior to running the EDA and data analysis scripts.
</span>'

### 
```{r}
reactable::reactable(
  tree_revisit %>%
  dplyr::filter(Status_mismatch == TRUE | 
                  Crown_mismatch == TRUE |
         DBH_mismatch == TRUE | 
           Status_Fallacy == "Flag"|Naming_error == "Flag"), 
  filterable = TRUE
)
```

Vegetation {data-width=650}
=======================================================================

### Vascular Species
<font size="3">**Vascular  plant  species  richness  across  multiple  spatial  scales. The data are summarized by total number of native versus non-native species/plot, and by vegetative growth forms. Growth form information was obtained from the USDA Plants Database (USDA 2020). **</font>

Inputs {.sidebar data-width=225}
-------------------------------------
```{r}

renderUI({
  selectInput(
    "rich_group",
    label = strong("Habitat Grouping: "),
    choices = c("Park_Code","Subunit_Code"),
    selected =  "Park_Code")
  })

```

Column
-------------------------------------
### Something
```{r}
output$richness <- renderReactable({
  reactable::reactable(rv$df_rich,
                     defaultColDef = colDef(
                       #html = TRUE,
                                              vAlign = "center",
                                              headerVAlign = "bottom",
                                              align = "left",
                                            class = "cell",
                                            headerClass = "header",
                                            headerStyle = list(fontWeight = 500)
                                            ),
                     columns = list(
                       #`Park_Code` = colDef(name= "Park Code",  filterable = TRUE, html = FALSE),
                      `Native<sup>a</sup>` = colDef(html = TRUE),
                      `Non-Native<sup>a</sup>` = colDef(html = TRUE),
                      `Uknown<sup>a</sup>` = colDef(html = TRUE)
                      ),
                     pagination = FALSE,
                     highlight = TRUE,
                     fullWidth = TRUE
                     ,
                     details = function(index) {
                       sub_plotrich <- df_plotrich %>% dplyr::filter(!!as.name(input$rich_group) == rv$df_rich[input$rich_group][index,])
                       htmltools::div(
                         style = "padding: 20px",
                         reactable(sub_plotrich,
                                   defaultColDef = colDef(vAlign = "center",
                                                          headerVAlign = "bottom",
                                                          html = TRUE,
                                                          align = "left"
                                   ,
                                   class = "cell",
                                   headerClass = "header",
                                   headerStyle = list(fontWeight = 500)
                                   ),
                                  columns = list(
                                    `Plot_Code` = colDef(name = "Plot Code", class = "cell") ,
                                    `Native<sup>a</sup>` = colDef(class = "border-left"),
                                    `Non-Native<sup>a</sup>`= colDef(class = "group"),
                                    `Unknown<sup>a</sup>` = colDef(class = "group"),
                                    `H <sup>a</sup>` = colDef(class = "border-left"),
                                    `H <sup>b</sup>` = colDef(class = "border-left"),
                                    `H <sup>c</sup>` = colDef(class = "border-left"),
                                    `H <sup>d</sup>` = colDef(class = "border-left")),
                                     compact = TRUE


                                   )
                       )
                                   }
                     )
})

reactableOutput("richness")

# saveRDS(df_parkrich, here::here("df_parkrich.RDS"))
# saveRDS(df_plotrich, here::here("df_plotrich.RDS"))
```

Tree Mortality 
=======================================================================

Row {data-width=350}
-------------------------------------
### Plot Level

```{r}
reactable::reactable(
  woody_b2_general,
    defaultColDef = colDef(html = T, 
                           vAlign = "center",
                           headerVAlign = "bottom",
                           class = "cell",
                           headerClass = "header",
                           maxWidth = 70,
                           headerStyle = list(fontWeight = 500), 
                           align= "left"), 
    pagination = F, 
    defaultSorted = "Species", 
    defaultSortOrder = "asc",
 # fullWidth = T,
    columns = list(
      Species = colDef(maxWidth = 100)
    )
    )
```
###  Species Level

```{r}
reactable::reactable(
  df_woodystem,
    defaultColDef = colDef(html = T, 
                           vAlign = "center",
                           headerVAlign = "bottom",
                           class = "cell",
                           headerClass = "header", 
                           maxWidth = 70,
                           headerStyle = list(fontWeight = 500), 
                           align = "left"), 
    pagination = F, 
    defaultSorted = "Plot", 
    defaultSortOrder = "asc",
#  fullWidth = T,
    columns = list(
      Plot = colDef(name = "Plot Code", maxWidth = 100)
    )
    )
```

Static Bar Chart {data-orientation3=columns}
=======================================================================

Column {.tabset .tabset-fade}
-------------------------------------

### Total Counts
```{r}

```

### Data Table
```{r}
reactable(constancy_final)
```

Column {.tabset .tabset-fade}
-------------------------------------
### Appalachian & Interior Mesophytic Forest
```{r}
#fig8_replicate
```

### South-Central Interior Oak Forest
```{r}
#fig8_replicateB

```

Bar Charts 
=======================================================================


Column {.sidebar data-width=200}
-------------------------------------
```{r}
# selectInput("categorical_variable", label = "Select Community Type:", choices = Categorical.Variables)
# 
# selectInput("numeric_variable", label = "Select Growth Form:", choices = Numeric.Variables)
# 

```


Plot {column data-width=600}
-------------------------------------
### Bar Plots

```{r}
# renderPlotly({
#    plot_ly(USNVC_fulltest,
#               x = ~USNVC_fulltest[[input$numeric_variable]],
#               color = ~USNVC_fulltest[[input$categorical_variable]],
#               colors = "Paired",
#               type = "box", 
#            label = F) %>%
#   layout(title = "",
#          xaxis = list(title = "" ,
#                       zeroline = FALSE,  showticklabels = F),
#          yaxis = list(showticklabels = F, showLegend = FALSE))
# })
```


Leaflet Maps {data-width=350}
=======================================================================

