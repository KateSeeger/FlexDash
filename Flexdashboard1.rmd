---
title: "Flexdashboard1.0"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: scroll
    theme:  
          version: 4
          bootswatch: litera
runtime: shiny

---
```{r include = FALSE}
knitr::opts_chunk$set(echo = FALSE)

#qaqc list - put in document this dashboard does this to clean the dashboard
#do the DBH - BA conversion - would need the event table
#data check page, highlight records with potential problems
#reactables filter each column
#tbl_
#plot_
#df_

```

```{r setup, include=FALSE}

rm(list=ls())
### NOTES
# Converted all tibbles to data frames to get rid of phantom column name errors

### NAMING RULES
# Functions: FuncTest(dat1_there, dat2_here)
# Action buttons: button_PushMe
# User inputs: sel_SelectMe
# Lists, data frames, vectors, variables...: station_files_list, station_df,  station_vec, here_is_a_variable
# Data frame cols: df$ColThisOne, df$ColThatOne
# List elements: list$ElementOne, list$ElementTwo
# Reactive elements: rv$ThisOne, rv$ThatOne
# Temporary variables: temp_this_df
# Well panel id's: wp_FilterParkSite

### Load libraries -----
# Will automatically install any libraries it can't find
pkgs <- c("flexdashboard", 
              "shiny", 
              "knitr", 
              "odbc", # pull data from SQL server
              "scales",
              "zoo",
              "leaflet", 
              "here",
              "RgoogleMaps", # for mapzoom
              "plotly", 
              "tidyverse", 
              "plyr", 
              "sf",
              "readr",
              "magrittr",
              "bslib", 
              "ggplot2",
              "patchwork",
              "webshot2",
              "leaflet.extras", 
              "lubridate", 
              "here", 
              "httr", # use web services
              "rgdal", # to use readOGR
              "sp", # transform projections
              "purrr", # for applying functions to dplyr groups
              "dataMaid", # for data checks
              "shinyFiles", # for user to save files in specified location
              "RColorBrewer", # to display brewer palettes
              "shinyjs", # for easy functions that use JavaScript
              "stringr", # to detect text snippets
              "tmaptools", # for flexible color mapping
              "reactable",
              "base", 
              "htmltools", 
              "ggthemes",
              "psych",
              "sparkline",
              "data.table", # for fast lag calcs
              "DT", # for interactive tables
              "zoo", # for year-month and carry-forward NA's for lag
              "cowplot", # to get legends from plots
              "crosstalk", # for SharedData
              "gridExtra", # for arranging plots and adding plot annotations (ggplotly can't do captions or subtitles)
              "RgoogleMaps", # for MaxZoom & MinZoom
              "leaflet.minicharts") # for pie charts in leaflet maps


installed_pkgs <- pkgs %in% installed.packages()
if (length(pkgs[!installed_pkgs]) > 0) install.packages(pkgs[!installed_pkgs],dep=TRUE) 
lapply(pkgs, library, character.only = TRUE)

invisible(lapply(pkgs, library, character.only = TRUE))

rv <- reactiveValues(
  select_group = NULL, 
  rich_group = NULL, 
  df_rich = NULL, 
  Spatial_Scale = NULL, 
  Individual_Unit = NULL, 
  Community_Group = NULL, 
  plotly_tree = NULL, 
  df_treeplot = NULL, 
  year = NULL,
  park_zoom = NULL
)
```

```{r data}
# reading in data -----
# setwd("C:/Users/kseeger/OneDrive - DOI/Desktop/GIT_RSTUDIO/FLEXDASHBOARD")

# Reading in CSV files
tree_basics <- read_csv(here::here("Data_In", "TreeBasics_20221013.csv"))
seedling_sapling <- read_csv(here::here("Data_In", "SeedlingSapling_20221013.csv"))
cwd_basics <- read_csv(here::here("Data_In","CWD_Basics_20221013.csv"))
canopy_cover <- read_csv(here::here("Data_In","CanopyCover_20221021.csv"))
USNVC <- read_csv(here::here("Data_In","USNVC_dev.csv"))
USNVC_parent <- read_csv(here::here("Data_In","USNVC.csv"))
constancy <- read_csv(here::here("Data_In","Constancy_Data.csv"))
constancy_full <- read_csv(here::here("Data_In","Constancy_Data_Full.csv"))
species_rich <- read_csv(here::here("Data_In","SpeciesDiversity_LongFormat.csv"))
stand_height <- read_csv(here::here("Data_In", "CUPN_StandHeight.csv"))
genus <- read_csv(here::here("Data_In", "CUPN_genus.csv"))
cupn_plots <- read_csv(here::here("Data_In", "CUPN_PlotEvents_LatLong.csv"))


```

```{r functions}
### Functions-----

#rounding function 
#stick to a certain function naming rule
round_df <- function(x, digits) {
    numeric_columns <- sapply(x, mode) == 'numeric'
    x[numeric_columns] <-  round(x[numeric_columns], digits)
    x
}

options(scipen=999)

#keeping only first letter of character
makeInitials <- function(charVec) {
  make.unique(vapply(strsplit(toupper(charVec), " "), 
                     function(x) paste(substr(x, 1, 1), collapse = ""), 
                     vector("character", 1L)))
}


Okabe_Ito <- c("#E69F00", "#56B4E9", "#009E73", '#CC6677',"#F0E442", "#0072B2", "#D55E00", 
               "#CC79A7", "#000000",'#DDDDDD', '#EE6678', '#99DDFF', 
               '#BBCC33', '#332288', '#882255', '#FFAABB')

okabe_ito <- c( "#0072B2", "#D55E00", 
               "#CC79A7", "#000000",  '#CC6677', '#BBCC33', '#99DDFF', 
                '#332288', '#882255', '#FFAABB', "#E69F00", "#56B4E9", "#009E73", "#F0E442")

viridis <- c("#fde725", "#5ec962", "#21918c","#3b528b","#440154")

# color_pallete_function <- colorRampPalette(
#   colors = Okabe_Ito, 
#   space = "Lab")
# 
# num_colors <- nlevels(BISCCHH_SP_Rich$Species)
# okabepalette <- color_pallete_function(num_colors)
# okabepalette <- setNames(okabepalette, levels(BISCCHH_SP_Rich$Species))

makefun <- function(data) {
  data %>% 
  dplyr::group_by(Plot_Code, Year) %>%
  dplyr::summarize(n())
  
}
##### css functions
integer_columns <- function(maxWidth = 60, ...) {
  colDef(maxWidth = maxWidth, align = "center",...)
}
```

```{css styles}
.border-left {
  border-left: 14px solid #000;
  font-size: 12px
}

.header { 
  border-bottom-color: #555;
  border-top-color: #555;
  font-size: 13px;
  font-weight: 600;
}

.group {
  font-size: 12px;
}

.reactable {
font-size: 12px; 
}

.cell {
  font-size: 12px;

}
```

```{r }
#Creating year variable 
genus <- genus %>%
  dplyr::select(-Space_Index)
tree_basics$Year <- year(mdy(tree_basics$Start_Date))
tree_basics <- left_join(tree_basics, genus, by = "Plant_Code") 
seedling_sapling <- left_join(seedling_sapling, genus, by = "Plant_Code")
USNVC_parent <- USNVC_parent %>%
  select(-c(Community_2, Community_3, Parent_2, Parent_3))

```

```{r plot rich}
species_rich <- species_rich %>%
  tidyr::replace_na(list(Nativity = "Unknown"))

#reduce code!!!!

#Summarizing nativity of species per plot
#Using Species_Diversity_ID not Plant Code because doesn't account for sp level differences at plot level 
#Species_Diversity_ID is used differently for each plot, so not a useful metric for species diversity across lager scales (i.e. parks, subunits, etc,)
 
plot_nativity <- species_rich %>%
  dplyr::filter(Sample_Depth_Code != 0) %>%
  dplyr::mutate(Sample_Depth_Code = as.factor(Sample_Depth_Code)
         ) %>%
  dplyr::group_by(Park_Code, Subunit_Code, Plot_Code, Start_Date, Species_Diversity_ID,
           Nativity) %>%
  dplyr::count(Nativity)

plot_nativity <- plot_nativity %>%
  dplyr::group_by(Park_Code, Subunit_Code, Plot_Code, Start_Date) %>%
  dplyr::count(Nativity)

plot_nativity <- plot_nativity %>%
  tidyr::pivot_wider(
    names_from = Nativity, 
    values_from = n
  )

plot_nativity <- plot_nativity %>%
  dplyr::rename_at(vars(-Park_Code, -Subunit_Code, -Plot_Code, -Start_Date),function(x) paste0(x,"<sup>a</sup>"))

###400 m2 
plot_total <- species_rich %>%
  dplyr::filter(Sample_Depth_Code != 0) %>%
  dplyr::mutate(Sample_Depth_Code = as.factor(Sample_Depth_Code), 
                Growth_Form = toupper(Growth_Form)) %>%
  dplyr::group_by(Park_Code, Subunit_Code, Plot_Code, Start_Date, Species_Diversity_ID, Growth_Form)%>%
  dplyr::count(Growth_Form)

plot_total <- plot_total %>%
  dplyr::group_by(Park_Code, Subunit_Code, Plot_Code, Start_Date, Growth_Form) %>%
  dplyr::summarize(Count = n())

###100m2
plot_mod100 <- species_rich %>%
  dplyr::filter(Sample_Depth_Code != 0) %>%
  dplyr::mutate(Sample_Depth_Code = as.factor(Sample_Depth_Code), 
         Growth_Form = toupper(Growth_Form)) %>%
  dplyr::group_by(Park_Code,
                  Subunit_Code, 
                  Plot_Code, 
                  Start_Date,
           Growth_Form,
           Module, 
           Species_Diversity_ID) %>%
  dplyr::count(Species_Diversity_ID)%>%
  ungroup() %>%
  dplyr::group_by(Park_Code,
                  Subunit_Code, 
                  Plot_Code, 
                  Start_Date,
                  Growth_Form,
                  Module, 
                  Species_Diversity_ID) %>%
  dplyr::count(Module) %>%
  ungroup()%>%
  dplyr::group_by(Park_Code,
                  Subunit_Code, 
                  Plot_Code,
                  Start_Date,
                  Growth_Form,
                  Module) %>%
  dplyr::summarize(numSpecies = sum(n))%>%
  ungroup() %>%
  dplyr::group_by(Park_Code, 
                  Subunit_Code, 
                  Plot_Code,
                  Start_Date,
                  Growth_Form) %>%
  dplyr::summarize(Mod100 = mean(numSpecies)) %>%
  ungroup() %>%
  group_by(Park_Code,
           Subunit_Code, 
           Plot_Code,
           Start_Date,
           Growth_Form) %>%
  dplyr::summarize(Mod100 = sum(Mod100))%>%
  dplyr::ungroup()

### 10m2
plot_mod10 <- species_rich %>%
  dplyr::filter(Sample_Depth_Code != 0, 
         Sample_Depth_Code != 1) %>%
  dplyr::mutate(Sample_Depth_Code = as.factor(Sample_Depth_Code), 
         Growth_Form = toupper(Growth_Form)) %>%
  dplyr::group_by(Park_Code,
                  Subunit_Code, 
                  Plot_Code, 
                  Start_Date,
           Growth_Form,
           Module,
           Corner,
           Species_Diversity_ID) %>%
  dplyr::count(Species_Diversity_ID)%>%
  ungroup() %>%
  dplyr::group_by(Park_Code,
                  Subunit_Code, 
                  Plot_Code, 
                  Start_Date,
           Growth_Form,
           Module,
           Corner,
           Species_Diversity_ID) %>%
  dplyr::count(Corner) %>%
  ungroup()%>%
  dplyr::group_by(Park_Code,
                  Subunit_Code, 
                  Plot_Code,
                  Start_Date,
           Growth_Form,
           Module,
           Corner) %>%
  dplyr::summarize(numSpecies = sum(n)) %>%
  ungroup() %>%
  dplyr::group_by(Park_Code,
                  Subunit_Code, 
                  Plot_Code,
                  Start_Date,
                  Growth_Form) %>%
  dplyr::summarize(Mod10 = mean(numSpecies)) %>%
  ungroup() %>%
  dplyr::group_by(Park_Code, Subunit_Code, Plot_Code, Start_Date,
           Growth_Form) %>%
  dplyr::summarize(Mod10 = sum(Mod10))

###1m2
plot_mod1 <- species_rich %>%
  dplyr::filter(Sample_Depth_Code == 3) %>%
  dplyr::mutate(Sample_Depth_Code = as.factor(Sample_Depth_Code), 
         Growth_Form = toupper(Growth_Form)) %>%
  dplyr::group_by(Park_Code,
                  Subunit_Code, 
                  Plot_Code, 
                  Start_Date,
           Growth_Form, 
           Module,
           Corner,
           Species_Diversity_ID) %>%
  dplyr::count(Species_Diversity_ID)%>%
  ungroup()%>%
  dplyr::group_by(Park_Code,
                  Subunit_Code, 
                  Plot_Code, 
                  Start_Date,
           Growth_Form, 
           Module, 
           Corner,
           Species_Diversity_ID) %>%
  dplyr::count(Corner)%>%
  ungroup()%>%
  dplyr::group_by(Park_Code,
                  Subunit_Code, 
                  Plot_Code,
                  Start_Date,
           Growth_Form,
           Module, 
           Corner) %>%
  dplyr::summarize(numSpecies = sum(n))%>%
  ungroup()%>%
  dplyr::group_by(Park_Code,
                  Subunit_Code, 
                  Plot_Code,
                  Start_Date,
                  Growth_Form) %>%
  dplyr::summarize(Mod1 = mean(numSpecies))%>%
  ungroup()%>%
  dplyr::group_by(Park_Code, Subunit_Code, Plot_Code,Start_Date,
           Growth_Form) %>%
  dplyr::summarize(Mod1 = sum(Mod1))

### full join
plot_rich <- Reduce(function (...) { merge(..., all = TRUE) },  
                           list(plot_total, plot_mod100, plot_mod10, plot_mod1))

plot_rich <- plot_rich %>%
    mutate(Growth_Form = mapply(function(charVec) makeInitials(charVec), Growth_Form)) #BHT = `GROUP`

plot_rich <- plot_rich %>%
  tidyr::pivot_wider(
    names_from = Growth_Form, 
    values_from = c(Count,
                    Mod100,
                    Mod10, 
                    Mod1), 
    names_prefix = "")

plot_rich <- Reduce(function (...) { merge(..., all = TRUE) },  # Full join
                           list(plot_nativity, plot_rich))

plot_rich <- round_df(plot_rich, 1)

plot_rich <- plot_rich %>%
    replace(is.na(.), 0)

plot_rich <- plot_rich %>%
  dplyr::rename_at(vars(starts_with("Count_")), 
            list(~paste(.,"<sup>a</sup>"))) %>%
  dplyr::rename_at(vars(starts_with("Mod100_")), 
            list(~paste(.,"<sup>b</sup>"))) %>%
  dplyr::rename_at(vars(starts_with("Mod10_")), 
            list(~paste(., "<sup>c</sup>"))) %>%
  dplyr::rename_at(vars(starts_with("Mod1_")), 
            list(~paste(., "<sup>d</sup>")))

names(plot_rich) = gsub(pattern = "Count_", replacement = "", x = names(plot_rich))
names(plot_rich) = gsub(pattern = "Mod100_", replacement = "", x = names(plot_rich))
names(plot_rich) = gsub(pattern = "Mod10_", replacement = "", x = names(plot_rich))
names(plot_rich) = gsub(pattern = "Mod1_", replacement = "", x = names(plot_rich))

df_plotrich <- plot_rich
```

```{r INPUT XXX RICH}
renderUI({
  shiny::req(!is.null(input$rich_group), !is.null(species_rich))
  
#use all_of in select(input$code) 

park_nativity <- species_rich %>%
  dplyr::filter(Sample_Depth_Code != 0) %>%
  dplyr::mutate(Sample_Depth_Code = as.factor(Sample_Depth_Code)
         ) %>%
  dplyr::select(all_of(input$rich_group), Network_Scientific_Name,
           Nativity) %>%
  dplyr::distinct()

park_nativity <- park_nativity %>%
  dplyr::group_by(!!as.name(input$rich_group))%>%
  dplyr::count(Nativity)

park_nativity <- park_nativity %>%
  tidyr::pivot_wider(
    names_from = Nativity, 
    values_from = n
  )

park_nativity <- park_nativity %>%
  dplyr::rename_at(vars(-input$rich_group),function(x) paste0(x,"<sup>a</sup>"))

###400 m2 
park_total <- species_rich %>%
  dplyr::filter(Sample_Depth_Code != 0) %>%
  dplyr::mutate(Sample_Depth_Code = as.factor(Sample_Depth_Code), 
                Growth_Form = toupper(Growth_Form)) %>%
  dplyr::group_by(!!as.name(input$rich_group), Network_Scientific_Name, Growth_Form)%>%
  dplyr::count(Growth_Form)

park_total <- park_total %>%
  dplyr::group_by(!!as.name(input$rich_group), Growth_Form) %>%
  dplyr::summarize(Count = n())

###100m2
park_mod100 <- species_rich %>%
  dplyr::filter(Sample_Depth_Code != 0) %>%
  dplyr::mutate(Sample_Depth_Code = as.factor(Sample_Depth_Code), 
         Growth_Form = toupper(Growth_Form)) %>%
  dplyr::group_by(!!as.name(input$rich_group),
           Growth_Form,
           Module, 
           Network_Scientific_Name) %>%
  dplyr::count(Network_Scientific_Name)%>%
  ungroup() %>%
  dplyr::group_by(!!as.name(input$rich_group), 
                  Growth_Form,
                  Module, 
                  Network_Scientific_Name) %>%
  dplyr::count(Module) %>%
  ungroup()%>%
  dplyr::group_by(!!as.name(input$rich_group), 
                  Growth_Form,
                  Module) %>%
  dplyr::summarize(numSpecies = sum(n))%>%
  ungroup() %>%
  dplyr::group_by(!!as.name(input$rich_group),
                  Growth_Form) %>%
  dplyr::summarize(Mod100 = mean(numSpecies)) %>%
  ungroup() %>%
  group_by(!!as.name(input$rich_group),
           Growth_Form) %>%
  dplyr::summarize(Mod100 = sum(Mod100))%>%
  dplyr::ungroup()

### 10m2
park_mod10 <- species_rich %>%
  dplyr::filter(Sample_Depth_Code != 0, 
         Sample_Depth_Code != 1) %>%
  dplyr::mutate(Sample_Depth_Code = as.factor(Sample_Depth_Code), 
         Growth_Form = toupper(Growth_Form)) %>%
  dplyr::group_by(!!as.name(input$rich_group), 
           Growth_Form,
           Module,
           Corner,
           Network_Scientific_Name) %>%
  dplyr::count(Network_Scientific_Name)%>%
  ungroup() %>%
  dplyr::group_by(!!as.name(input$rich_group), 
           Growth_Form,
           Module,
           Corner,
           Network_Scientific_Name) %>%
  dplyr::count(Corner) %>%
  ungroup()%>%
  dplyr::group_by(!!as.name(input$rich_group), 
           Growth_Form,
           Module,
           Corner) %>%
  dplyr::summarize(numSpecies = sum(n)) %>%
  ungroup() %>%
  dplyr::group_by(!!as.name(input$rich_group),
                  Growth_Form) %>%
  dplyr::summarize(Mod10 = mean(numSpecies)) %>%
  ungroup() %>%
  dplyr::group_by(!!as.name(input$rich_group), 
           Growth_Form) %>%
  dplyr::summarize(Mod10 = sum(Mod10))

###1m2
park_mod1 <- species_rich %>%
  dplyr::filter(Sample_Depth_Code == 3) %>%
  dplyr::mutate(Sample_Depth_Code = as.factor(Sample_Depth_Code), 
         Growth_Form = toupper(Growth_Form)) %>%
  dplyr::group_by(!!as.name(input$rich_group), 
           Growth_Form, 
           Module,
           Corner,
           Network_Scientific_Name) %>%
  dplyr::count(Network_Scientific_Name)%>%
  ungroup()%>%
  dplyr::group_by(!!as.name(input$rich_group), 
           Growth_Form, 
           Module, 
           Corner,
           Network_Scientific_Name) %>%
  dplyr::count(Corner)%>%
  ungroup()%>%
  dplyr::group_by(!!as.name(input$rich_group),
           Growth_Form,
           Module, 
           Corner) %>%
  dplyr::summarize(numSpecies = sum(n))%>%
  ungroup()%>%
  dplyr::group_by(!!as.name(input$rich_group),
                  Growth_Form) %>%
  dplyr::summarize(Mod1 = mean(numSpecies))%>%
  ungroup()%>%
  dplyr::group_by(!!as.name(input$rich_group),
           Growth_Form) %>%
  dplyr::summarize(Mod1 = sum(Mod1))

### full join
park_rich <- Reduce(function (...) { merge(..., all = TRUE) },  
                           list(park_total, park_mod100, park_mod10, park_mod1))

park_rich <- park_rich %>%
    mutate(Growth_Form = mapply(function(charVec) makeInitials(charVec), Growth_Form)) #BHT = `GROUP`

park_rich <- park_rich %>%
  tidyr::pivot_wider(
    names_from = Growth_Form, 
    values_from = c(Count,
                    Mod100,
                    Mod10, 
                    Mod1), 
    names_prefix = "")

park_rich <- Reduce(function (...) { merge(..., all = TRUE) },  # Full join
                           list(park_nativity, park_rich))

park_rich <- round_df(park_rich, 1)

park_rich <- park_rich %>%
    replace(is.na(.), 0)

park_rich <- park_rich %>%
  dplyr::rename_at(vars(starts_with("Count_")), 
            list(~paste(.,"<sup>a</sup>"))) %>%
  dplyr::rename_at(vars(starts_with("Mod100_")), 
            list(~paste(.,"<sup>b</sup>"))) %>%
  dplyr::rename_at(vars(starts_with("Mod10_")), 
            list(~paste(., "<sup>c</sup>"))) %>%
  dplyr::rename_at(vars(starts_with("Mod1_")), 
            list(~paste(., "<sup>d</sup>")))

names(park_rich) = gsub(pattern = "Count_", replacement = "", x = names(park_rich))
names(park_rich) = gsub(pattern = "Mod100_", replacement = "", x = names(park_rich))
names(park_rich) = gsub(pattern = "Mod10_", replacement = "", x = names(park_rich))
names(park_rich) = gsub(pattern = "Mod1_", replacement = "", x = names(park_rich))


rv$df_rich <- park_rich

saveRDS(isolate(reactiveValuesToList(input)), paste0("rich_input.RDS"))
saveRDS(isolate(reactiveValuesToList(rv)), paste0("rich_rv.RDS"))

})
```

```{r tree basics}
#Tree_Basics 
tree_basics_barplot <- tree_basics %>%
  dplyr::filter(Event_Type_Name != "QA/QC") %>%
  dplyr::group_by(Plot_Code,
           Plant_Code, Genus,
           Event_Type_Name,
           Start_Date) %>%
  dplyr::summarize(Tree = n())
```

```{r seedsap basics}

#Seedling Sapling Count 
sapling_barplot <- seedling_sapling %>%
  dplyr::filter(Event_Type_Name != "QA/QC") %>%
  dplyr::select(Plot_Code, 
         Plant_Code, Genus, 
         Start_Date, 
         Event_Type_Name, 
         Sapling_0_1_DBH,
         Sapling_1_2half_DBH, 
         Sapling_2half_5_DBH,
         Sapling_5_10_DBH) %>%
  replace(is.na(.), 0) %>%
  dplyr::mutate(SapCount = rowSums(across(where(is.numeric))))
    
sapling_barplot <- sapling_barplot %>%
  dplyr::group_by(Plot_Code, 
           Start_Date, 
           Event_Type_Name,
           Plant_Code, Genus) %>%
  dplyr::summarize(Sapling = sum(SapCount))
      
#Seedling Count
seedling_barplot <- seedling_sapling %>%
  dplyr::filter(Event_Type_Name != "QA/QC") %>%
  dplyr::select(Plot_Code,
         Plant_Code, Genus,
         Start_Date,
         Event_Type_Name,
         Seedling_15_30_Tall,
         Seedling_5_15_Tall, 
         Seedling_30_50_Tall,
         Seedling_50_137_Tall) %>%
  replace(is.na(.), 0) %>%
  dplyr::mutate(SeedCount = rowSums(across(where(is.numeric))))
    
seedling_barplot <- seedling_barplot %>%
  dplyr::group_by(Plot_Code, Start_Date, Event_Type_Name, Plant_Code, Genus) %>%
  dplyr::summarize(Seedling = sum(SeedCount))
 
#Creating table with sum counts woody strata 

tree_full <- Reduce(function (...) { merge(..., all = TRUE) },  # Full join
                           list(seedling_barplot,
                                sapling_barplot,
                                tree_basics_barplot))

```

```{r tree basics 2}
tree_full <- left_join(USNVC_parent, tree_full, by = c("Plot_Code", "Start_Date", "Event_Type_Name"))

tree_full <- tree_full %>%
  dplyr::mutate_if(is.numeric, ~replace(., is.na(.), 0)) %>%
  dplyr::mutate(Genus = as.factor(Genus))
```

```{r tree basics 3}
tree_full <- tree_full %>%
  pivot_longer(cols = c(Seedling, Sapling, Tree), 
               names_to = "Strata", 
               values_to = "Count")
positions <- c("Seedling", "Sapling", "Tree")

```

```{r tree basics 4}
observeEvent(eventExpr = input$button_UpdatePlots, {
  shiny::req(!is.null(tree_full), !is.null(input$Spatial_Scale), !is.null(input$Individual_Unit), !is.null(input$Community_Group))
  
  df_tree <- tree_full %>%
    dplyr::filter(!!as.name(input$Spatial_Scale) == input$Individual_Unit) %>%
    dplyr::filter(Community_1 %in% input$Community_Group) %>%
    dplyr::group_by(Community_1, Strata, Genus) %>%
    dplyr::summarize(Sum = sum(Count)) %>%
    top_n(8, Sum) %>%
    droplevels() 

color_pallete_function <- colorRampPalette(
  colors = Okabe_Ito, 
  space = "Lab")

num_colors <- nlevels(df_tree$Genus)
okabepalette <- color_pallete_function(num_colors)
okabepalette <- setNames(okabepalette, levels(df_tree$Genus))


page_height = length(unique(df_tree$Community_1)) * 300 + 150
  
plot_tree <- df_tree %>%
  ggplot(aes(x = Strata,
             y = Sum, 
             fill = Genus)) + 
  geom_bar(position = "fill",
           stat = "identity") + 
  theme_clean() + 
  labs(x = "", y = "") + 
  scale_fill_manual(values = okabepalette[unique(df_tree$Genus)],
                      drop = TRUE) +
  scale_x_discrete(limits = positions) + 
  facet_wrap(~ Community_1 , ncol = 1) 
 
x <- length(unique(df_tree$Community_1))

#rv$plotly_tree <- function (x) {
  rv$plotly_tree <-
if (x == 1 ) {
       ggplotly(plot_tree, height = page_height) %>%
  layout(margin = list(
    l = 50,
  r = 50,
  b = 100,
  t = 100,
  pad = 4), 
  legend = list(orientation = 'h',
                xanchor = "center",
                borderwidth = 0.5,
                x = 0.5,
                y = -0.2,
                title = list(font = list(size = 12)),
                font = list(size = 11)))
    }
 
   else {
       ggplotly(plot_tree, height = page_height) %>%
  layout(margin = list(
    l = 50,
  r = 50,
  b = 100,
  t = 100,
  pad = 4), 
  legend = list(title = list(font = list(size = 12)),
                font = list(size = 11)))
  }

})

```

```{r seedsap plot1}
### Seedling_Sapling per plot

#Calculating DBH using arithmetic average
seedsap_plot <- seedling_sapling %>%
  dplyr::mutate(
    Start_Date = as.character(mdy(Start_Date)),
    Corner = as.factor(Corner), 
    Module = as.factor(Module)) %>%
  dplyr::filter(Event_Type_Name != "QA/QC") %>%
  dplyr::group_by(Network_Code, 
                  State_Code, 
                  Park_Code,
                  Subunit_Code, 
                  Plot_Code, 
                  Start_Date) %>%
  dplyr::summarise(across(where(is.numeric), sum, na.rm = TRUE), .groups = "drop")

#Calculating Sapling BA (m2/ha) by calculating with bined arithmetic average
seedsap_plot <- seedsap_plot %>%
  dplyr::mutate(
    Sapling01_BA = (0.00007854 * ((Sapling_0_1_DBH*0.5) ^2)),
    Sapling12h_BA = (0.00007854* ((Sapling_1_2half_DBH*1.75) ^2)),
    Sapling2h5_BA = (0.00007854 * ((Sapling_2half_5_DBH*3.25) ^2)),
    Sapling510_BA = (0.00007854* ((Sapling_5_10_DBH*7.5)^2)))

#Finding sums of Sapling/Seedlings/BA
seedsap_plot <- seedsap_plot %>%
  group_by(Plot_Code, Start_Date) %>%
  dplyr::mutate(Seedling_Density = sum(Seedling_15_30_Tall,
                                Seedling_30_50_Tall,
                                Seedling_50_137_Tall), #count/8 m2
         Sapling_BA = sum(Sapling01_BA, 
                              Sapling12h_BA, 
                              Sapling2h5_BA,
                              Sapling510_BA)/0.008, #m2/ha
         Sapling_Density = sum(Sapling_0_1_DBH,
                               Sapling_1_2half_DBH,
                               Sapling_2half_5_DBH,
                               Sapling_5_10_DBH)) #count/80m2

df_seedsapplot <- seedsap_plot %>%
  dplyr::select(Network_Code, 
                State_Code,
                Park_Code, 
                Subunit_Code,
                Plot_Code,
                Start_Date,
                Sapling_BA,
                Sapling_Density,
                Seedling_Density)
#Stand height
df_stndhtplot <- stand_height %>%
  dplyr::filter(Event_Type != "QA/QC") %>%
  dplyr::mutate(Start_Date = lubridate::dmy(Start_Date)) %>%
  dplyr::select(Plot_Code, Start_Date, Stand_Height)
  
#Basal area in square meters = pi * (dbh^2) / 40000
tree_badenplot <- tree_basics %>%
  dplyr::mutate(Start_Date = lubridate::mdy(Start_Date)) %>%
  dplyr::filter(Event_Type_Name != "QA/QC") %>%
  dplyr::mutate(Tree_BA = (0.00007854 * (DBH^2)/0.04)) #m2/ha

#count number of observations of trees for tree density
df_trdbhplot <- tree_badenplot %>%
  dplyr::group_by(Network_Code, 
                State_Code,
                Park_Code, 
                Subunit_Code,
                Plot_Code, 
                Start_Date) %>%
  dplyr::summarize(Tree_DBH = n()) #count/400m2

df_treebaplot <- tree_badenplot %>% 
  dplyr::group_by(Network_Code, 
                State_Code,
                Park_Code, 
                Subunit_Code,
                Plot_Code,
                Start_Date) %>%
  dplyr::summarise(Tree_BA = sum(Tree_BA, na.rm = TRUE))

df_treefullplot <- Reduce(function (...) { merge(..., all = TRUE) },  # Full join
                           list(df_treebaplot, df_trdbhplot, df_stndhtplot))


#% Canopy Cover
df_cancovplot <- canopy_cover %>%
  mutate(Start_Date = mdy(Start_Date)) %>%
  dplyr::filter(Event_Type_Name != "QA/QC") %>%
  dplyr::group_by(Network_Code, 
                State_Code,
                Park_Code, 
                Subunit_Code, 
                Plot_Code, 
                Start_Date) %>%
  dplyr::summarize(Canopy_Cover_Percent = mean(Canopy_Cover_Percent))
```

```{r seedsap plot2}
df_treeplot <- Reduce(function (...) { merge(..., all = TRUE) },  # Full join
                           list(df_treefullplot, df_seedsapplot, df_cancovplot))

df_treeplot <- df_treeplot %>%
  mutate(Start_Date = as.character(Start_Date))

df_treeplot <- round_df(df_treeplot, 1)

df_treeplot$Year <- year(ymd(df_treeplot$Start_Date))

#HTML compatible code 
df_treeplot <- df_treeplot %>%
  dplyr::rename(Plot = Plot_Code,
                `Start Date` = Start_Date,
    `Tree Basal Area <br> (m<sup>2</sup>/ha)` = Tree_BA,
    `Tree Density <br> (400m<sup>2</sup>) ` = Tree_DBH,
    `Seedling Density <br> (8m<sup>2</sup>)` = Seedling_Density,
    `Sapling Basal Area <br> (m<sup>2</sup>/ha)` = Sapling_BA,
    `Sapling Density <br> (80m<sup>2</sup>)` = Sapling_Density,
    `Mean Canopy Cover <br> (%)` = Canopy_Cover_Percent,
    `Mean Stand Height <br> (m)` = Stand_Height)


# woodystem_round_b2_blank[is.na(woodystem_round_b2)] <- "-"
#reactable::reactable(colDef(percent= T))
```

```{r seedsap plot3}
observeEvent(eventExpr = input$button_UpdateTable, {
  
  shiny::req(!is.null(input$year), !is.null(df_treeplot), !is.null(input$group_var))
  
# input <- list()
# input$year <- "All"
#   
 
if (input$year == "All") {
   df_filter <-  df_treeplot
    
  }
  else {
     df_filter <- df_treeplot %>%
  filter(Year == input$year)
  }
  
rv$df_treeplot <- reactable::reactable(df_filter,
                     striped = TRUE,
                     highlight = TRUE,
                     bordered = TRUE,
                     fullWidth = TRUE,
                     showPageSizeOptions = TRUE,
                     pagination = F,
                     compact = TRUE,
                     height = 600,
                     filterable = TRUE,
                     defaultColDef = colDef(aggregate = "mean",
                                            html = TRUE,
                                            vAlign = "center",
                                            headerVAlign = "bottom",
                                            align = "left",
                                            class = "group",
                                            headerClass = "header",
                                            maxWidth = 75,
                                            headerStyle = list(fontWeight = 500),
                                            format = colFormat(digits = 1)),
                     groupBy = input$group_var,
                     columns = list(
                       `Plot_Code` = colDef(
                         aggregate = "count",
                         format = list(aggregated = colFormat(suffix = " Plots"))),
                         Network_Code = colDef(name = "Network Code", aggregate = "unique", maxWidth = 70),
                         State_Code = colDef(name = "State Code", maxWidth = 70, aggregate = "unique"),
                         Park_Code = colDef(name = "Park Code", aggregate = "frequency", maxWidth =70),
                         Subunit_Code = colDef(name = "Subunit Code", aggregate = "frequency"),
                       Year = colDef(name = "Start Year", aggregate = "min")
                     ))

saveRDS(isolate(reactiveValuesToList(input)), paste0("treeplot_input.RDS"))
saveRDS(isolate(reactiveValuesToList(rv)), paste0("treeplot_rv.RDS"))

})

```

```{r cover}
#Constancy_Table
#Finding average mean plot cover by species across broad habitat types
cover_calc <- constancy_full %>%
  dplyr::select(`BROAD HABITAT TYPE`,
                Species_Original,
                `Mean Plot Cover`) %>%
  dplyr::group_by(`BROAD HABITAT TYPE`,
           Species_Original) %>%
  dplyr::summarise(Avg_MPC = mean(`Mean Plot Cover`))%>%
  ungroup()

cover_calc <- cover_calc %>%
  mutate(Group = mapply(function(charVec) makeInitials(charVec), `BROAD HABITAT TYPE`)) #BHT = `GROUP`
  
cover_calc <- cover_calc %>%
  select(Species_Original, Group, Avg_MPC) %>%
    pivot_wider(names_from = `Group`, 
    values_from = Avg_MPC
  )

cover_code <- cover_calc %>%
  mutate_if(is.numeric, list(~case_when(
    . >= 0 & . <=0.1~ "1",
                     . >= 0.1 & . <=1~ "2",
                     . >= 1 & . <= 2 ~ "3",
                     . >= 2 & . <= 5 ~ "4",
                     . >= 5 & . <= 10 ~ "5",
                     . >= 10 & . <=25~ "6",
                     . >= 25 & . <=50~ "7",
                     . >= 50 & . <= 75 ~ "8",
                     . >= 75 & . <=95 ~ "9",
                     . >= 95 & . <= 100 ~ "10" )
  ))

cover_code <- cover_code %>%
  rename_at(vars(-Species_Original),function(x) paste0(x,"_Cover")) %>% #general code would be -Plant_Code
  mutate_at(vars(-Species_Original), as.integer)
```

```{r constancy}
# Constancy Count
constancy_count <- constancy_full %>%
  dplyr::select(`BROAD HABITAT TYPE`, Species_Original, `Mean Plot Cover`) %>%
  dplyr::group_by(`BROAD HABITAT TYPE`, Species_Original) %>%
  dplyr::summarise(Species_Total = n()) 

constancy_count <- constancy_count %>%
  tidyr::pivot_wider(
    names_from = `BROAD HABITAT TYPE`, 
    values_from = Species_Total
  )

#calculating constancy count
constancy_plot_num <- constancy_full%>%
  dplyr::group_by(`BROAD HABITAT TYPE`, event_name_date_calc) %>% #UNSURE IS EVENT_NAME_DATE_CALC IS A UNIVERSAL VARIABLE
  dplyr::summarize(n()) %>%
  ungroup() %>%
  dplyr::group_by(`BROAD HABITAT TYPE`) %>%
  dplyr::summarize(Num_Plots = n())

constancy_count <- constancy_full %>%
  dplyr::select(`BROAD HABITAT TYPE`, Species_Original, `Mean Plot Cover`) %>%
  dplyr::group_by(`BROAD HABITAT TYPE`, Species_Original) %>%
  dplyr::summarise(Species_Total = n()) 

constancy_count <- left_join(constancy_count, constancy_plot_num, by = "BROAD HABITAT TYPE")

constancy_count <- constancy_count %>% 
  dplyr::group_by(`BROAD HABITAT TYPE`) %>%
  dplyr::mutate(Constancy = (Species_Total/Num_Plots)*100) %>%
  dplyr::select(`BROAD HABITAT TYPE`, Species_Original, Constancy) %>%
  ungroup()

constancy_count <- constancy_count %>%
   dplyr::mutate(Group = mapply(function(charVec) makeInitials(charVec), `BROAD HABITAT TYPE`)) #BHT = `GROUP`

constancy_count <- constancy_count %>%
  dplyr::select(-`BROAD HABITAT TYPE`) %>%
  tidyr::pivot_wider(names_from = Group, 
              values_from = Constancy)

constancy_count <- constancy_count %>%
    rename_at(vars(-Species_Original),function(x) paste0(x,"_Constancy"))

constancy_count <- round_df(constancy_count, 0)

```

```{r covcon}
#CODE FOR Constancy/Count CREATING FINAL DATASET

constancy_final <- Reduce(function (...) { merge(..., all = TRUE) },  #full join idk why I can't just do a regular left join....
                        list(cover_code, constancy_count))

constancy_final[constancy_final == 0] <- NA

constancy_final[is.na(constancy_final)] <- "-"

constancy_final<- constancy_final  %>%
  tidyr::pivot_longer(cols = - Species_Original,
               names_to = "codes", 
               values_to = "value") %>%
  dplyr::arrange(codes) %>%
  tidyr::pivot_wider(names_from = "codes", 
              values_from = "value")

df_constancyfinal <- constancy_final
```

```{r cupn map 1}
cupn_plots_select <- cupn_plots %>%
    dplyr::rename(Park_Code = Unit_Code) %>%
    dplyr::select(Park_Code, Subunit_Code, Plot_Code, Start_Date, Latitude, Longitude)

cupn_plots_select$Start_Date <- dmy(cupn_plots_select$Start_Date)

cupn_plots_select <- cupn_plots_select %>%
  dplyr::group_by(Plot_Code) %>%
  slice(which.max(Start_Date)) %>%
  dplyr::mutate(Year = lubridate::year(Start_Date))

```

```{r cupn map 2, message = FALSE, results = FALSE, echo = FALSE}
cupn_boundary <- st_read(here::here('./cupn_shapefile/CUPN.shp'))

cupn_boundary <- st_transform(cupn_boundary, crs = 4326)

```

```{r cupn map 3}
top_species <- seedling_sapling %>%
  dplyr::filter(Event_Type_Name != "QA/QC") %>%
dplyr::mutate(Plant_Code = as.factor(Plant_Code)) %>%
  dplyr::group_by(Plant_Code) %>%
  dplyr::summarise(Observations = n()) %>%
  dplyr::arrange(desc(Observations))  %>%
dplyr::mutate(Plant_Code = as.character(Plant_Code))

top_species <- as.data.frame(top_species[top_species$Observations >400,])

tree_basics_count <- tree_basics %>%
  dplyr::filter(Event_Type_Name != "QA/QC") %>%
dplyr::filter(Status_Code == 1) %>%
  dplyr::mutate(Basal_Area_ha = ((pi * DBH^2) /40000 )/0.04)

#Tree
top_tree <- tree_basics_count %>%
dplyr::mutate(Plant_Code = as.factor(Plant_Code)) %>%
  dplyr::group_by(Plant_Code) %>%
  dplyr::summarise(Observations = n()) %>%
  dplyr::arrange(desc(Observations))  %>%
dplyr::mutate(Plant_Code = as.character(Plant_Code))

top_tree <- as.data.frame(top_tree[top_tree$Observations >300,])
```

```{r cupn map 4}
#creating list of most frequently occuring tree species

species_col_palette <- inner_join(top_tree, top_species, by = "Plant_Code")
  
species_col_palette <- species_col_palette %>%
  dplyr::select(Plant_Code) %>%
  dplyr::mutate(Plant_Code = as.factor(Plant_Code))

species_col_palette <- unique(species_col_palette)

tree_count_test <- tree_basics_count %>%
dplyr::filter(Plant_Code %in% species_col_palette$Plant_Code)

```

```{r cupn map 5}
#creating "Other category" in tree species count

tree_basics_test_other <- tree_basics_count %>%
dplyr::filter(!Plant_Code %in% species_col_palette$Plant_Code)

tree_basics_test_other <- tree_basics_test_other %>%
  dplyr::group_by(Park_Code, Subunit_Code, Plot_Code) %>%
  dplyr::summarize(Other = n())
```

```{r cupn map 6}
#creating tree_count: # basal area, # other, # obs per species

#count number of observations of trees for tree density
tree_count_test <- tree_count_test %>%
  dplyr::group_by(Park_Code, Subunit_Code, Plot_Code, Plant_Code) %>%
  dplyr::summarize(DBH_Obs = n()) %>%
  ungroup()

tree_count_test <- tree_count_test %>%
  tidyr::pivot_wider(names_from = Plant_Code, 
              values_from = DBH_Obs)

tree_count_test <- tree_count_test %>%
  dplyr::select(Park_Code, Subunit_Code, Plot_Code, sort(tidyselect::peek_vars()))

tree_ba_test<- tree_basics_count %>%
  dplyr::group_by(Park_Code, Subunit_Code, Plot_Code) %>%
  dplyr::summarise(Sum = sum(Basal_Area_ha))

tree_plot_test <-  Reduce(function (...) { merge(..., all = TRUE) },  # Full join
                           list(tree_ba_test, tree_basics_test_other, tree_count_test, cupn_plots_select))

tree_plot_test <- tree_plot_test %>%
  filter(!is.na(Latitude)) %>%
  filter(!is.na(Longitude))
```

```{r cupn map 7}
# input <- list() 
# input$input_park <- "ABLI"
 renderUI({
   shiny::req(!is.null(input$input_park), !is.null(tree_plot_test))
   
   rv$park_zoom <- tree_plot_test %>%
     dplyr::filter(Park_Code == input$input_park)
   
 saveRDS(isolate(reactiveValuesToList(input)), paste0("park_input.RDS"))
 saveRDS(isolate(reactiveValuesToList(rv)), paste0("park_rv.RDS"))

})

```





Diversity and Abundance {data-width=650}
=======================================================================

### Vascular Species
<font size="3">**Vascular  plant  species  richness  across  multiple  spatial  scales. The data are summarized by total number of native versus non-native species/plot, and by vegetative growth forms. Growth form information was obtained from the USDA Plants Database (USDA 2020). **</font>

Inputs {.sidebar data-width=225}
-------------------------------------
```{r}

renderUI({
  selectInput(
    "rich_group",
    label = strong("Spatial Grouping: "),
    choices = c("Park_Code","Subunit_Code"),
    selected =  "Park_Code")
  })

```

Column
-------------------------------------

```{r}

output$richness <- renderReactable({
  shiny::req(!is.null(rv$df_rich), !is.null(input$rich_group), !is.null(df_plotrich))
  
  reactable::reactable(rv$df_rich,
                     defaultColDef = colDef(vAlign = "center",
                                            headerVAlign = "bottom",
                                            align = "left",
                                            class = "group",
                                            headerClass = "header",
                                            maxWidth = 55,
                                            headerStyle = list(fontWeight = 500)
                                            ),
                     columns = list(
                       `Park_Code` = colDef(name= "Park Code",  filterable = TRUE, html = FALSE, maxWidth = 70),
                       `Subunit_Code` = colDef(name = "Subunit_Code", filterable = TRUE, maxWidth = 70),
                      `Native<sup>a</sup>` = colDef(html = TRUE, maxWidth = 70),
                      `Non-Native<sup>a</sup>` = colDef(html = TRUE, maxWidth = 70),
                      `Unknown<sup>a</sup>` = colDef(html = TRUE, maxWidth = 70),
                      `H <sup>a</sup>` = colDef(html = TRUE, class = "border-left"),
                      `S <sup>a</sup>` = colDef(html = TRUE),
                      `T <sup>a</sup>` = colDef(html = TRUE),
                      `TS <sup>a</sup>` = colDef(html = TRUE),
                      `H <sup>b</sup>` = colDef(html = TRUE, class = "border-left"),
                      `S <sup>b</sup>` = colDef(html = TRUE),
                      `T <sup>b</sup>` = colDef(html = TRUE),
                      `TS <sup>b</sup>` = colDef(html = TRUE),
                      `H <sup>c</sup>` = colDef(html = TRUE, class = "border-left"),
                      `S <sup>c</sup>` = colDef(html = TRUE),
                      `T <sup>c</sup>` = colDef(html = TRUE),
                      `TS <sup>c</sup>` = colDef(html = TRUE),
                      `H <sup>d</sup>` = colDef(html = TRUE, class = "border-left"),
                      `S <sup>d</sup>` = colDef(html = TRUE),
                      `T <sup>d</sup>` = colDef(html = TRUE),
                      `TS <sup>d</sup>` = colDef(html = TRUE)),
                     pagination = FALSE,
                     highlight = TRUE,
                     fullWidth = TRUE, 
                     compact = T
                     ,
                     details = function(index) {
                       sub_plotrich <- df_plotrich %>% dplyr::filter(!!as.name(input$rich_group) == rv$df_rich[input$rich_group][index,])
                       htmltools::div(
                         style = "padding: 20px",
                         reactable(sub_plotrich,
                                   defaultColDef = colDef(vAlign = "center",
                                                          headerVAlign = "bottom",
                                                          html = TRUE,
                                                          maxWidth = 45,
                                                          align = "left"
                                   ,
                                   class = "cell",
                                   headerClass = "header",
                                   headerStyle = list(fontWeight = 500)
                                   ),
                                  columns = list(
                                    `Subunit_Code` = colDef(name = "Subunit Code", maxWidth = 70),
                                    `Plot_Code` = colDef(name = "Plot Code", class = "cell") ,
                                    `Start_Date` = colDef(name = "Start Date", maxWidth = 70),
                                    `Native<sup>a</sup>` = colDef(class = "border-left", maxWidth = 70),
                                    `Non-Native<sup>a</sup>`= colDef(class = "group", maxWidth = 70),
                                    `Unknown<sup>a</sup>` = colDef(class = "group",  maxWidth = 70),
                                    `H <sup>a</sup>` = colDef(class = "border-left"),
                                    `H <sup>b</sup>` = colDef(class = "border-left"),
                                    `H <sup>c</sup>` = colDef(class = "border-left"),
                                    `H <sup>d</sup>` = colDef(class = "border-left")),
                                     compact = TRUE, 
                                  pagination = F


                                   )
                       )
                                   }
                     )
})

reactableOutput("richness")

# saveRDS(df_parkrich, here::here("df_parkrich.RDS"))
# saveRDS(df_plotrich, here::here("df_plotrich.RDS"))
```

Woody Plant Characteristics 
=======================================================================

Inputs {.sidebar data-width=225}
-------------------------------------
```{r echo=FALSE}
actionButton("button_UpdateTable", "Update Table") 

selectInput(
  "year", 
  label = strong("Select Year: "), 
  choices = c("All", sort(unique(df_treeplot$Year))), 
  selected = "All"
)

renderUI({
  shiny::req(!is.null(input$year), !is.null(df_treeplot))
  selectInput(
  "group_var",
  label = strong("Spatial Grouping: "),
  choices = c("Park_Code","Subunit_Code"),
  selected =  "Park_Code")
  
})

```

Row
-------------------------------------
```{r}
output$seedsapplot <- renderReactable({
  shiny::req(!is.null(input$year), !is.null(rv$df_treeplot), !is.null(input$group_var))
  
  rv$df_treeplot
  
})


reactableOutput("seedsapplot")

```

Relative Proportion of Species Groups {data-orientation3=columns}
=======================================================================

Inputs {.sidebar data-width=225}
-------------------------------------
```{r sidebar input}

actionButton("button_UpdatePlots", "Update Plots") 


selectInput(
  "Spatial_Scale", 
  label = "Select Spatial Scale: ",
  choices = c("Network_Code", "Park_Code", "Subunit_Code")
)

#selectInput only shows column name when just one value is possible
renderUI({ #needed bc reactive
  shiny::req(!is.null(input$Spatial_Scale), !is.null(tree_full))
  selectInput(
    "Individual_Unit", 
    label = paste0("Select Individual Unit of ", input$Spatial_Scale, ":" ), 
    choices = unique(tree_full[input$Spatial_Scale])
  )

# input <- list()
# input$Spatial_Scale <- "Network_Code"
#   
})

renderUI({
  shiny::req(!is.null(input$Spatial_Scale), !is.null(input$Individual_Unit), !is.null(tree_full))
  communitychoice <- tree_full %>%
    dplyr::filter(!!as.name(input$Spatial_Scale) == input$Individual_Unit) %>%
    distinct(Community_1) %>%
    pull(.)

  
  checkboxGroupInput(
    "Community_Group", 
    label = "Select at least one Community Group", 
    choices = communitychoice
  )
  
})
```

###
-------------------------------------

```{r}
output$plotly_tree <- renderPlotly({
  shiny::req(!is.null(rv$plotly_tree))
  rv$plotly_tree})

plotlyOutput("plotly_tree")

```


<!-- Constancy  -->
<!-- ======================================================================= -->


<!-- Column {.tabset .tabset-fade} -->
<!-- ------------------------------------- -->

<!-- ### Total Counts -->
<!-- ```{r} -->

<!-- ``` -->

<!-- ### Data Table -->
<!-- ```{r} -->
<!-- reactable(constancy_final) -->
<!-- ``` -->

<!-- Column {.tabset .tabset-fade} -->
<!-- ------------------------------------- -->
<!-- ```{r} -->

<!-- ``` -->


Maps {data-width=350}
=======================================================================


Inputs {.sidebar data-width=225}
-------------------------------------
```{r cupn map input, echo = FALSE}
renderUI({
  shiny::req(!is.null(tree_plot_test))

  selectInput(
    "input_park",
    label = strong("Select a Park: "),
    choices = sort(unique(tree_plot_test$Park_Code)),
    selected = switch(is.null(input$input_park)+1, input$input_park, "ABLI")
    )
  })

```

Column {data-width=350}
-----------------------------------------------------------------------

### CUPN Tree Canopy Composition

```{r CUPN map, echo = FALSE}
 output$leaflet <- renderLeaflet({
  shiny::req(!is.null(cupn_boundary), !is.null(rv$park_zoom), !is.null(tree_plot_test))


  bc = leaflet::leaflet(data = cupn_boundary) %>%
    addTiles() %>%
     addPolygons(data = cupn_boundary, color = ~ "black")# %>%
    # addCircleMarkers(data = cupn_plots, cupn_plots$Longitude,
    #                 cupn_plots$Latitude,  color = ~ "black", weight = 1, fillColor = ~"blue", fillOpacity = 1, radius = 4)

  bc <- bc %>%
    addMinicharts(tree_plot_test$Longitude,
                tree_plot_test$Latitude,
    chartdata = dplyr::select(tree_plot_test, -c(Park_Code, Subunit_Code, Plot_Code, Latitude, Longitude, Start_Date, Year, Sum)),
    type = "pie",
    width = sqrt(tree_plot_test$Sum) * 4,
    col = okabe_ito,
    showLabels = F) %>%
  addLabelOnlyMarkers(cupn_plots_select$Longitude,
                cupn_plots_select$Latitude, label =  cupn_plots_select$Plot_Code,
                      labelOptions = labelOptions(noHide = T, direction = 'top', textOnly = T, style=list('color'="#ffffff", 'fontSize'="15px"))) %>%
  fitBounds(min(rv$park_zoom$Longitude), min(rv$park_zoom$Latitude), max(rv$park_zoom$Longitude), max(rv$park_zoom$Latitude))


})


leafletOutput("leaflet")
```

