---
title: "Flexdashboard1.0"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: scroll
    theme:  
          version: 4
          bootswatch: litera
  
runtime: shiny
---
```{r}
#qaqc list - put in document this dashboard does this to clean the dashboard
#do the DBH - BA conversion - would need the event table
#data check page, highlight records with potential problems
#reactables filter each column
#tbl_
#plot_
#df_

```

```{r setup, include=FALSE}

rm(list=ls())
### NOTES
# Converted all tibbles to data frames to get rid of phantom column name errors

### NAMING RULES
# Functions: FuncTest(dat1_there, dat2_here)
# Action buttons: button_PushMe
# User inputs: sel_SelectMe
# Lists, data frames, vectors, variables...: station_files_list, station_df, station_vec, here_is_a_variable
# Data frame cols: df$ColThisOne, df$ColThatOne
# List elements: list$ElementOne, list$ElementTwo
# Reactive elements: rv$ThisOne, rv$ThatOne
# Temporary variables: temp_this_df
# Well panel id's: wp_FilterParkSite

### Load libraries -----
# Will automatically install any libraries it can't find
pkgs <- c("flexdashboard", 
              "shiny", 
              "knitr", 
              "odbc", # pull data from SQL server
              "scales",
              "leaflet", 
              "here",
              "RgoogleMaps", # for mapzoom
              "plotly", 
              "tidyverse", 
              "plyr", 
              "readr",
              "magrittr",
              "bslib", 
              "ggplot2",
              "gt", 
              "patchwork",
              "webshot2",
              "leaflet.extras", 
              "lubridate", 
              "here", 
              "httr", # use web services
              "rgdal", # to use readOGR
              "sp", # transform projections
              "purrr", # for applying functions to dplyr groups
              "dataMaid", # for data checks
              "shinyFiles", # for user to save files in specified location
              "RColorBrewer", # to display brewer palettes
              "shinyjs", # for easy functions that use JavaScript
              "stringr", # to detect text snippets
              "tmaptools", # for flexible color mapping
              "reactable",
              "base", 
              "htmltools", 
              "ggthemes",
              "psych",
              "sparkline",
              "data.table", # for fast lag calcs
              "DT", # for interactive tables
              "zoo", # for year-month and carry-forward NA's for lag
              "cowplot", # to get legends from plots
              "crosstalk", # for SharedData
              "gridExtra", # for arranging plots and adding plot annotations (ggplotly can't do captions or subtitles)
              "RgoogleMaps", # for MaxZoom & MinZoom
              "leaflet.minicharts") # for pie charts in leaflet maps


installed_pkgs <- pkgs %in% installed.packages()
if (length(pkgs[!installed_pkgs]) > 0) install.packages(pkgs[!installed_pkgs],dep=TRUE) 
lapply(pkgs, library, character.only = TRUE)

invisible(lapply(pkgs, library, character.only = TRUE))

rv <- reactiveValues(
  select_group = NULL, 
  rich_group = NULL, 
  df_rich = NULL
)
```

```{r data}
# reading in data -----
# setwd("C:/Users/kseeger/OneDrive - DOI/Desktop/GIT_RSTUDIO/FLEXDASHBOARD")

# Reading in CSV files
# tree_basics <- read_csv(here::here("FLEXDASHBOARD", "TreeBasics_20221013.csv"))
# seedling_sapling <- read_csv(here::here("FLEXDASHBOARD", "SeedlingSapling_20221013.csv"))
# cwd_basics <- read_csv(here::here("FLEXDASHBOARD","CWD_Basics_20221013.csv"))
# canopy_cover <- read_csv(here::here("FLEXDASHBOARD","CanopyCover_20221021.csv"))
# USNVC <- read_csv(here::here("FLEXDASHBOARD","USNVC_dev.csv"))
# USNVC_parent <- read_csv(here::here("FLEXDASHBOARD","USNVC.csv"))
# constancy <- read_csv(here::here("FLEXDASHBOARD","Constancy_Data.csv"))
# constancy_full <- read_csv(here::here("FLEXDASHBOARD","Constancy_Data_Full.csv"))
species_rich <- read_csv(here::here("FLEXDASHBOARD", "SpeciesDiversity_LongFormat.csv"))

```

```{r functions}
### Functions-----

#rounding function 
#stick to a certain function naming rule
round_df <- function(x, digits) {
    numeric_columns <- sapply(x, mode) == 'numeric'
    x[numeric_columns] <-  round(x[numeric_columns], digits)
    x
}

options(scipen=999)

#keeping only first letter of character
makeInitials <- function(charVec) {
  make.unique(vapply(strsplit(toupper(charVec), " "), 
                     function(x) paste(substr(x, 1, 1), collapse = ""), 
                     vector("character", 1L)))
}


Okabe_Ito <- c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", 
               "#CC79A7", "#000000",  '#CC6677','#DDDDDD', '#EE6677', '#99DDFF', 
               '#BBCC33', '#332288', '#882255', '#FFAABB')

# color_pallete_function <- colorRampPalette(
#   colors = Okabe_Ito, 
#   space = "Lab")
# 
# num_colors <- nlevels(BISCCHH_SP_Rich$Species)
# okabepalette <- color_pallete_function(num_colors)
# okabepalette <- setNames(okabepalette, levels(BISCCHH_SP_Rich$Species))


##### css functions
integer_columns <- function(maxWidth = 60, ...) {
  colDef(maxWidth = maxWidth, align = "center",...)
}
```

```{css styles, eval = FALSE}
.border-left {
  border-left: 12px solid #555;
}

.header { 
  border-bottom-color: #555;
  border-top-color: #555;
  font-size: 13px;
  font-weight: 500;
}

.group {
  font-size: 12px;
}

.reactable {
font-size: 12px; 
}

.cell {
  font-size: 12px;

}
```


```{r plot richness}
species_rich <- species_rich %>%
  tidyr::replace_na(list(Nativity = "Unknown"))

#Summarizing nativity of species per plot
#Using Species_Diversity_ID not Plant Code because doesn't account for sp level differences at plot level 
#Species_Diversity_ID is used differently for each plot, so not a useful metric for species diversity across lager scales (i.e. parks, subunits, etc,)
 
plot_nativity <- species_rich %>%
  dplyr::filter(Sample_Depth_Code != 0) %>%
  dplyr::mutate(Sample_Depth_Code = as.factor(Sample_Depth_Code)
         ) %>%
  dplyr::group_by(Park_Code, Subunit_Code, Plot_Code, Species_Diversity_ID,
           Nativity) %>%
  dplyr::count(Nativity)

plot_nativity <- plot_nativity %>%
  dplyr::group_by(Park_Code, Subunit_Code, Plot_Code) %>%
  dplyr::count(Nativity)

plot_nativity <- plot_nativity %>%
  tidyr::pivot_wider(
    names_from = Nativity, 
    values_from = n
  )

plot_nativity <- plot_nativity %>%
  dplyr::rename_at(vars(-Park_Code, -Subunit_Code, -Plot_Code),function(x) paste0(x,"<sup>a</sup>"))

###400 m2 
plot_total <- species_rich %>%
  dplyr::filter(Sample_Depth_Code != 0) %>%
  dplyr::mutate(Sample_Depth_Code = as.factor(Sample_Depth_Code), 
                Growth_Form = toupper(Growth_Form)) %>%
  dplyr::group_by(Park_Code, Subunit_Code, Plot_Code, Species_Diversity_ID, Growth_Form)%>%
  dplyr::count(Growth_Form)

plot_total <- plot_total %>%
  dplyr::group_by(Park_Code, Subunit_Code, Plot_Code, Growth_Form) %>%
  dplyr::summarize(Count = n())

###100m2
plot_mod100 <- species_rich %>%
  dplyr::filter(Sample_Depth_Code != 0) %>%
  dplyr::mutate(Sample_Depth_Code = as.factor(Sample_Depth_Code), 
         Growth_Form = toupper(Growth_Form)) %>%
  dplyr::group_by(Park_Code,
                  Subunit_Code, 
                  Plot_Code, 
           Growth_Form,
           Module, 
           Species_Diversity_ID) %>%
  dplyr::count(Species_Diversity_ID)%>%
  ungroup() %>%
  dplyr::group_by(Park_Code,
                  Subunit_Code, 
                  Plot_Code, 
                  Growth_Form,
                  Module, 
                  Species_Diversity_ID) %>%
  dplyr::count(Module) %>%
  ungroup()%>%
  dplyr::group_by(Park_Code,
                  Subunit_Code, 
                  Plot_Code, 
                  Growth_Form,
                  Module) %>%
  dplyr::summarize(numSpecies = sum(n))%>%
  ungroup() %>%
  dplyr::group_by(Park_Code, 
                  Subunit_Code, 
                  Plot_Code,
                  Growth_Form) %>%
  dplyr::summarize(Mod100 = mean(numSpecies)) %>%
  ungroup() %>%
  group_by(Park_Code,
           Subunit_Code, 
           Plot_Code,
           Growth_Form) %>%
  dplyr::summarize(Mod100 = sum(Mod100))%>%
  dplyr::ungroup()

### 10m2
plot_mod10 <- species_rich %>%
  dplyr::filter(Sample_Depth_Code != 0, 
         Sample_Depth_Code != 1) %>%
  dplyr::mutate(Sample_Depth_Code = as.factor(Sample_Depth_Code), 
         Growth_Form = toupper(Growth_Form)) %>%
  dplyr::group_by(Park_Code,
                  Subunit_Code, 
                  Plot_Code, 
           Growth_Form,
           Module,
           Corner,
           Species_Diversity_ID) %>%
  dplyr::count(Species_Diversity_ID)%>%
  ungroup() %>%
  dplyr::group_by(Park_Code,
                  Subunit_Code, 
                  Plot_Code, 
           Growth_Form,
           Module,
           Corner,
           Species_Diversity_ID) %>%
  dplyr::count(Corner) %>%
  ungroup()%>%
  dplyr::group_by(Park_Code,
                  Subunit_Code, 
                  Plot_Code, 
           Growth_Form,
           Module,
           Corner) %>%
  dplyr::summarize(numSpecies = sum(n)) %>%
  ungroup() %>%
  dplyr::group_by(Park_Code,
                  Subunit_Code, 
                  Plot_Code,
                  Growth_Form) %>%
  dplyr::summarize(Mod10 = mean(numSpecies)) %>%
  ungroup() %>%
  dplyr::group_by(Park_Code, Subunit_Code, Plot_Code, 
           Growth_Form) %>%
  dplyr::summarize(Mod10 = sum(Mod10))

###1m2
plot_mod1 <- species_rich %>%
  dplyr::filter(Sample_Depth_Code == 3) %>%
  dplyr::mutate(Sample_Depth_Code = as.factor(Sample_Depth_Code), 
         Growth_Form = toupper(Growth_Form)) %>%
  dplyr::group_by(Park_Code,
                  Subunit_Code, 
                  Plot_Code, 
           Growth_Form, 
           Module,
           Corner,
           Species_Diversity_ID) %>%
  dplyr::count(Species_Diversity_ID)%>%
  ungroup()%>%
  dplyr::group_by(Park_Code,
                  Subunit_Code, 
                  Plot_Code, 
           Growth_Form, 
           Module, 
           Corner,
           Species_Diversity_ID) %>%
  dplyr::count(Corner)%>%
  ungroup()%>%
  dplyr::group_by(Park_Code,
                  Subunit_Code, 
                  Plot_Code,
           Growth_Form,
           Module, 
           Corner) %>%
  dplyr::summarize(numSpecies = sum(n))%>%
  ungroup()%>%
  dplyr::group_by(Park_Code,
                  Subunit_Code, 
                  Plot_Code,
                  Growth_Form) %>%
  dplyr::summarize(Mod1 = mean(numSpecies))%>%
  ungroup()%>%
  dplyr::group_by(Park_Code, Subunit_Code, Plot_Code,
           Growth_Form) %>%
  dplyr::summarize(Mod1 = sum(Mod1))

### full join
plot_rich <- Reduce(function (...) { merge(..., all = TRUE) },  
                           list(plot_total, plot_mod100, plot_mod10, plot_mod1))
```

```{r plot richness 2}
plot_rich <- plot_rich %>%
    mutate(Growth_Form = mapply(function(charVec) makeInitials(charVec), Growth_Form)) #BHT = `GROUP`

plot_rich <- plot_rich %>%
  tidyr::pivot_wider(
    names_from = Growth_Form, 
    values_from = c(Count,
                    Mod100,
                    Mod10, 
                    Mod1), 
    names_prefix = "")

plot_rich <- Reduce(function (...) { merge(..., all = TRUE) },  # Full join
                           list(plot_nativity, plot_rich))

plot_rich <- round_df(plot_rich, 1)

plot_rich <- plot_rich %>%
    replace(is.na(.), 0)

plot_rich <- plot_rich %>%
  dplyr::rename_at(vars(starts_with("Count_")), 
            list(~paste(.,"<sup>a</sup>"))) %>%
  dplyr::rename_at(vars(starts_with("Mod100_")), 
            list(~paste(.,"<sup>b</sup>"))) %>%
  dplyr::rename_at(vars(starts_with("Mod10_")), 
            list(~paste(., "<sup>c</sup>"))) %>%
  dplyr::rename_at(vars(starts_with("Mod1_")), 
            list(~paste(., "<sup>d</sup>")))

names(plot_rich) = gsub(pattern = "Count_", replacement = "", x = names(plot_rich))
names(plot_rich) = gsub(pattern = "Mod100_", replacement = "", x = names(plot_rich))
names(plot_rich) = gsub(pattern = "Mod10_", replacement = "", x = names(plot_rich))
names(plot_rich) = gsub(pattern = "Mod1_", replacement = "", x = names(plot_rich))

df_plotrich <- plot_rich
```

```{r PARK}
renderUI({
  shiny::req(!is.null(input$rich_group), !is.null(species_rich))
  
#use all_of in select(input$code) 

park_nativity <- species_rich %>%
  dplyr::filter(Sample_Depth_Code != 0) %>%
  dplyr::mutate(Sample_Depth_Code = as.factor(Sample_Depth_Code)
         ) %>%
  dplyr::select(all_of(input$rich_group), Network_Scientific_Name,
           Nativity) %>%
  dplyr::distinct()

park_nativity <- park_nativity %>%
  dplyr::group_by(!!as.name(input$rich_group))%>%
  dplyr::count(Nativity)

park_nativity <- park_nativity %>%
  tidyr::pivot_wider(
    names_from = Nativity, 
    values_from = n
  )

park_nativity <- park_nativity %>%
  dplyr::rename_at(vars(-input$rich_group),function(x) paste0(x,"<sup>a</sup>"))
```


```{r PARK}
#to create a function: 
#first (create something where we can input the variables and names to populate a dataset)
#keep all code in and join dataset, just decreases amount of code written
#somehow need to do a few if then statements....ummmm and include reactivity
#

###400 m2
```


```{r PARK}
park_total <- species_rich %>%
  dplyr::mutate(Sample_Depth_Code = as.factor(Sample_Depth_Code), 
                Growth_Form = toupper(Growth_Form))





funcrich <- function(species_rich) {
  dplyr::filter(Sample_Depth_Code != sample_depth_1) %>% 
  dplyr::group_by(!!as.name(input$rich_group), Network_Scientific_Name, Growth_Form)%>%
  dplyr::count(Growth_Form)

park_total <- park_total %>%
  dplyr::group_by(!!as.name(input$rich_group), Growth_Form) %>%
  dplyr::summarize(Count = n())
  
  
}


  dplyr::filter(Sample_Depth_Code != 0) %>%

  dplyr::group_by(!!as.name(input$rich_group), Network_Scientific_Name, Growth_Form)%>%
  dplyr::count(Growth_Form)

park_total <- park_total %>%
  dplyr::group_by(!!as.name(input$rich_group), Growth_Form) %>%
  dplyr::summarize(Count = n())
```

```{r}

```


```{r PARK}
###100m2
park_mod100 <- species_rich %>%
  dplyr::filter(Sample_Depth_Code != 0) %>%
  dplyr::mutate(Sample_Depth_Code = as.factor(Sample_Depth_Code), 
         Growth_Form = toupper(Growth_Form)) %>%
  dplyr::group_by(Subunit_Code, #!!as.name(input$rich_group)
           Growth_Form,
           Module, 
           Network_Scientific_Name) %>%
  dplyr::count(Network_Scientific_Name)%>%
  ungroup() %>%
  dplyr::group_by(!!as.name(input$rich_group), 
                  Growth_Form,
                  Module, 
                  Network_Scientific_Name) %>%
  dplyr::count(Module) %>%
  ungroup()%>%
  dplyr::group_by(!!as.name(input$rich_group), 
                  Growth_Form,
                  Module) %>%
  dplyr::summarize(numSpecies = sum(n))%>%
  ungroup() %>%
  dplyr::group_by(!!as.name(input$rich_group),
                  Growth_Form) %>%
  dplyr::summarize(Mod100 = mean(numSpecies)) %>%
  ungroup() %>%
  group_by(!!as.name(input$rich_group),
           Growth_Form) %>%
  dplyr::summarize(Mod100 = sum(Mod100))%>%
  dplyr::ungroup()
```


```{r PARK}

#these include corners and modules

### 10m2
park_mod10 <- species_rich %>%
  dplyr::filter(Sample_Depth_Code != 0, 
         Sample_Depth_Code != 1) %>%
  dplyr::mutate(Sample_Depth_Code = as.factor(Sample_Depth_Code), 
         Growth_Form = toupper(Growth_Form)) %>%
  dplyr::group_by(!!as.name(input$rich_group), 
           Growth_Form,
           Module,
           Corner,
           Network_Scientific_Name) %>%
  dplyr::count(Network_Scientific_Name)%>%
  ungroup() %>%
  dplyr::group_by(!!as.name(input$rich_group), 
           Growth_Form,
           Module,
           Corner,
           Network_Scientific_Name) %>%
  dplyr::count(Corner) %>%
  ungroup()%>%
  dplyr::group_by(!!as.name(input$rich_group), 
           Growth_Form,
           Module,
           Corner) %>%
  dplyr::summarize(numSpecies = sum(n)) %>%
  ungroup() %>%
  dplyr::group_by(!!as.name(input$rich_group),
                  Growth_Form) %>%
  dplyr::summarize(Mod10 = mean(numSpecies)) %>%
  ungroup() %>%
  dplyr::group_by(!!as.name(input$rich_group), 
           Growth_Form) %>%
  dplyr::summarize(Mod10 = sum(Mod10))

###1m2
park_mod1 <- species_rich %>%
  dplyr::filter(Sample_Depth_Code == 3) %>%
  dplyr::mutate(Sample_Depth_Code = as.factor(Sample_Depth_Code), 
         Growth_Form = toupper(Growth_Form)) %>%
  dplyr::group_by(!!as.name(input$rich_group), 
           Growth_Form, 
           Module,
           Corner,
           Network_Scientific_Name) %>%
  dplyr::count(Network_Scientific_Name)%>%
  ungroup()%>%
  dplyr::group_by(!!as.name(input$rich_group), 
           Growth_Form, 
           Module, 
           Corner,
           Network_Scientific_Name) %>%
  dplyr::count(Corner)%>%
  ungroup()%>%
  dplyr::group_by(!!as.name(input$rich_group),
           Growth_Form,
           Module, 
           Corner) %>%
  dplyr::summarize(numSpecies = sum(n))%>%
  ungroup()%>%
  dplyr::group_by(!!as.name(input$rich_group),
                  Growth_Form) %>%
  dplyr::summarize(Mod1 = mean(numSpecies))%>%
  ungroup()%>%
  dplyr::group_by(!!as.name(input$rich_group),
           Growth_Form) %>%
  dplyr::summarize(Mod1 = sum(Mod1))

### full join
park_rich <- Reduce(function (...) { merge(..., all = TRUE) },  
                           list(park_total, park_mod100, park_mod10, park_mod1))

park_rich <- park_rich %>%
    mutate(Growth_Form = mapply(function(charVec) makeInitials(charVec), Growth_Form)) #BHT = `GROUP`

park_rich <- park_rich %>%
  tidyr::pivot_wider(
    names_from = Growth_Form, 
    values_from = c(Count,
                    Mod100,
                    Mod10, 
                    Mod1), 
    names_prefix = "")

park_rich <- Reduce(function (...) { merge(..., all = TRUE) },  # Full join
                           list(park_nativity, park_rich))

park_rich <- round_df(park_rich, 1)

park_rich <- park_rich %>%
    replace(is.na(.), 0)

park_rich <- park_rich %>%
  dplyr::rename_at(vars(starts_with("Count_")), 
            list(~paste(.,"<sup>a</sup>"))) %>%
  dplyr::rename_at(vars(starts_with("Mod100_")), 
            list(~paste(.,"<sup>b</sup>"))) %>%
  dplyr::rename_at(vars(starts_with("Mod10_")), 
            list(~paste(., "<sup>c</sup>"))) %>%
  dplyr::rename_at(vars(starts_with("Mod1_")), 
            list(~paste(., "<sup>d</sup>")))

names(park_rich) = gsub(pattern = "Count_", replacement = "", x = names(park_rich))
names(park_rich) = gsub(pattern = "Mod100_", replacement = "", x = names(park_rich))
names(park_rich) = gsub(pattern = "Mod10_", replacement = "", x = names(park_rich))
names(park_rich) = gsub(pattern = "Mod1_", replacement = "", x = names(park_rich))


rv$df_rich <- park_rich

saveRDS(isolate(reactiveValuesToList(input)), paste0("rich_input.RDS"))
saveRDS(isolate(reactiveValuesToList(rv)), paste0("rich_rv.RDS"))

})
```


```{r}
# input <- list() 
# input$rich_group <- "Subunit_Code"
```





Data Check {data-width=650}
=======================================================================

<br>
<span style="font-size:14px; color:red; font-weight:bold;">
Data issues identified on this page should be fixed in the original data files. The data check should then be RERUN with the UPDATED data files, until data issues are resolved to the extent possible--prior to running the EDA and data analysis scripts.
</span>'

### 

Vegetation {data-width=650}
=======================================================================

### Vascular Species
<font size="3">**Vascular  plant  species  richness  across  multiple  spatial  scales. The data are summarized by total number of native versus non-native species/plot, and by vegetative growth forms. Growth form information was obtained from the USDA Plants Database (USDA 2020). **</font>

Inputs {.sidebar data-width=225}
-------------------------------------
```{r}

renderUI({
  
  selectInput(
    "rich_group",
    label = strong("Habitat Grouping: "),
    choices = c("Park_Code","Subunit_Code"),
    selected = "Park_Code"
    )
  })

```

Column
-------------------------------------
### Something
```{r}
renderReactable({
  reactable::reactable(rv$df_rich,
                   defaultColDef = colDef(
                     #html = TRUE,
                                            vAlign = "center",
                                            headerVAlign = "bottom",
                                            align = "left",
                                          class = "cell",
                                          headerClass = "header",
                                          headerStyle = list(fontWeight = 500)
                                          ),
                   columns = list(
                     #`Park_Code` = colDef(name= "Park Code",  filterable = TRUE, html = FALSE),
                    `Native<sup>a</sup>` = colDef(html = TRUE),
                    `Non-Native<sup>a</sup>` = colDef(html = TRUE),
                    `Uknown<sup>a</sup>` = colDef(html = TRUE)),
                   pagination = FALSE,
                   highlight = TRUE,
                   fullWidth = TRUE,
                   details = function(index) {
                      sub_plotrich <- df_plotrich %>% dplyr::filter(!!as.name(input$rich_group) == rv$df_rich[input$rich_group][index,])
                     htmltools::div(
                       style = "padding: 20px",
                       reactable(sub_plotrich,
                                 defaultColDef = colDef(vAlign = "center",
                                                        headerVAlign = "bottom",
                                                        html = TRUE,
                                                        align = "left"
                                 ,
                                 class = "cell",
                                 headerClass = "header",
                                 headerStyle = list(fontWeight = 500)
                                 ),
                                columns = list(
                                  `Plot_Code` = colDef(name = "Plot Code", class = "cell") ,
                                  `Native<sup>a</sup>` = colDef(class = "border-left"),
                                  `Non-Native<sup>a</sup>`= colDef(class = "group"),
                                  `Unknown<sup>a</sup>` = colDef(class = "group"),
                                  `H <sup>a</sup>` = colDef(class = "border-left"),
                                  `H <sup>b</sup>` = colDef(class = "border-left"),
                                  `H <sup>c</sup>` = colDef(class = "border-left"),
                                  `H <sup>d</sup>` = colDef(class = "border-left")),
                                   compact = TRUE )
                     )
                                 })

})


# saveRDS(df_parkrich, here::here("df_parkrich.RDS"))
# saveRDS(df_plotrich, here::here("df_plotrich.RDS"))
```
